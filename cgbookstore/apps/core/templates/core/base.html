<!-- template/base.html -->

<!DOCTYPE html>
{% load static %}

<html lang="pt-BR" {% if user.is_authenticated %}data-auth="true"{% endif %} class="">
<head>
    <!-- TESTE PARA VERIFICAR O ARQUIVO CORRETO - 28/08/2025 -->
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- BOOTSTRAP CSS - VERS√ÉO √öNICA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- BOOTSTRAP ICONS - VERS√ÉO √öNICA SEM INTEGRITY -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- SWIPER CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css">

    <!-- CSS CUSTOMIZADOS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="icon" href="{% static 'images/favicon.svg' %}" type="image/svg+xml">
    <link rel="stylesheet" href="{% static 'css/book-covers-fix.css' %}">
    <link rel="stylesheet" href="{% static 'css/events.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatbot_widget.css' %}">

    <title>{% block title %}CG.BookStore Online{% endblock %}</title>

    <style>
        /* Remove a setinha do dropdown Explorando */
        #exploreDropdown.dropdown-toggle::after {
            display: none !important;
        }

        /* Estilo para dropdown hover */
        .nav-item.dropdown:hover .dropdown-menu {
            display: block;
        }

        /* Corrigir posi√ß√£o do dropdown */
        .navbar .nav-item.dropdown {
            position: relative;
        }

        .navbar .nav-item.dropdown .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0;
        }

        /* Regra para esconder modais externos */
        #externalBookModal, #shelfSelectionModal {
            display: none;
        }
    </style>

    <!-- TEMA: Script bloqueante para evitar flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'auto';
            if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>

    {% block extra_css %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">
    {% comment %} === ESTA SE√á√ÉO DEVE EXISTIR === {% endcomment %}
    {% if background_settings and background_settings.habilitado %}
        <div class="custom-background
            position-{{ background_settings.posicao }}
            opacity-{{ background_settings.opacidade|floatformat:"0" }}
            {% if background_settings.aplicar_em == 'light' %}only-light{% elif background_settings.aplicar_em == 'dark' %}only-dark{% endif %}"
            style="background-image: url('{{ background_settings.imagem.url }}');">
        </div>
    {% endif %}

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="position: fixed; top: 0; left: 0; right: 0; width: 100%; z-index: 1020;">
        <a class="navbar-brand d-flex align-items-center" href="{% url 'core:index' %}">
            <img src="{% static 'images/logo.png' %}" alt="Logo" class="logo">
            <span class="store-name ml-2">CG.BookStore Online</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <!-- Links de navega√ß√£o -->
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="{% url 'core:index' %}">In√≠cio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/books/' %}active{% endif %}" href="{% url 'core:book_search' %}">Buscar Livro</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="exploreDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Explorando
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="exploreDropdown">
                        <li><a class="dropdown-item" href="{% url 'core:catalogue' %}">Cat√°logo Completo</a></li>
                        <li><a class="dropdown-item" href="{% url 'core:new_releases' %}">Novos Lan√ßamentos</a></li>
                        <li><a class="dropdown-item" href="{% url 'core:bestsellers' %}">Mais Vendidos</a></li>
                        <li><a class="dropdown-item" href="{% url 'core:recommended_books' %}">Recomendados</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/sobre/' %}active{% endif %}" href="{% url 'core:sobre' %}">Sobre</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/contato/' %}active{% endif %}" href="{% url 'core:contato' %}">Contato</a>
                </li>
                {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.path == '/profile/' %}active{% endif %}" href="{% url 'core:profile' %}">Perfil</a>
                    </li>
                    {% if user.is_staff %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.path == '/admin/' %}active{% endif %}" href="{% url 'admin:index' %}">Admin</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.path == '/analytics/dashboard/' %}active{% endif %}" href="/api/analytics/dashboard/">Analytics</a>
                        </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="themeToggle" title="Alternar tema">
                            <i class="bi bi-circle-half"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <form method="post" action="{% url 'core:logout' %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="nav-link" style="background: none; border: none;">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </button>
                        </form>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.path == '/register/' %}active{% endif %}" href="{% url 'core:register' %}">Registrar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.path == '/login/' %}active{% endif %}" href="{% url 'core:login' %}" title="Entrar">
                            <i class="bi bi-person" style="font-size: 1.4rem;"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="themeToggle" title="Alternar tema">
                            <i class="bi bi-circle-half"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <main class="main-content-wrapper">
        <!-- Linha decorativa -->
        <div class="line" style="margin-top: 60px;"></div>

        <!-- Conte√∫do principal -->
        <div class="container-fluid mt-4" style="padding-top: 20px;">
            {% block content %}
            {% endblock %}
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container py-5">
                <div class="row g-5">
                    <!-- Coluna 1: Sobre -->
                    <div class="col-lg-4">
                        <div class="footer-brand mb-4">
                            <img src="{% static 'images/logo.png' %}" alt="CG BookStore Logo" class="footer-logo mb-3">
                            <h2 class="brand-name h4 text-primary mb-3">CG BookStore</h2>
                        </div>
                        <p class="footer-about mb-4">
                            Conectando leitores a hist√≥rias incr√≠veis. Sua biblioteca digital para descobrir,
                            organizar e compartilhar experi√™ncias liter√°rias √∫nicas.
                        </p>
                        <div class="social-links">
                            <a href="https://www.instagram.com/cg.bookstore/" target="_blank" class="social-link">
                                <i class="bi bi-instagram"></i>
                            </a>
                            <a href="https://x.com/CG_BookStore" target="_blank" class="social-link">
                                <i class="bi bi-twitter-x"></i>
                            </a>
                            <a href="https://www.facebook.com/profile.php?id=61569188766565" target="_blank" class="social-link">
                                <i class="bi bi-facebook"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Outras colunas do footer... -->
                    <div class="col-lg-3 col-md-6">
                        <h3 class="footer-heading">Explorando</h3>
                        <ul class="footer-links">
                            <li><a href="{% url 'core:catalogue' %}"><i class="bi bi-chevron-right"></i> Cat√°logo</a></li>
                            <li><a href="{% url 'core:new_releases' %}"><i class="bi bi-chevron-right"></i> Novos Lan√ßamentos</a></li>
                            <li><a href="{% url 'core:bestsellers' %}"><i class="bi bi-chevron-right"></i> Mais Vendidos</a></li>
                            <li><a href="{% url 'core:recommended_books' %}"><i class="bi bi-chevron-right"></i> Recomendados</a></li>
                        </ul>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <h3 class="footer-heading">Links √öteis</h3>
                        <ul class="footer-links">
                            <li><a href="{% url 'core:sobre' %}"><i class="bi bi-chevron-right"></i> Sobre N√≥s</a></li>
                            <li><a href="{% url 'core:contato' %}"><i class="bi bi-chevron-right"></i> FAQ</a></li>
                            <li><a href="{% url 'core:contato' %}"><i class="bi bi-chevron-right"></i> Contato</a></li>
                            <li><a href="{% url 'core:planos' %}"><i class="bi bi-chevron-right"></i> Planos</a></li>
                            <li><a href="{% url 'core:index' %}"><i class="bi bi-chevron-right"></i> Blog Liter√°rio</a></li>
                        </ul>
                    </div>

                    <div class="col-lg-2 col-md-6">
                        <h3 class="footer-heading">Legal</h3>
                        <ul class="footer-links">
                            <li><a href="{% url 'core:politica_privacidade' %}"><i class="bi bi-chevron-right"></i> Privacidade</a></li>
                            <li><a href="{% url 'core:termos_uso' %}"><i class="bi bi-chevron-right"></i> Termos de Uso</a></li>
                            <li><a href="{% url 'core:politica_privacidade' %}"><i class="bi bi-chevron-right"></i> Cookies</a></li>
                        </ul>
                    </div>
                </div>

                <hr class="footer-divider">

                <!-- Copyright -->
                <div class="footer-bottom row align-items-center">
                    <div class="col-md-6">
                        <p class="copyright mb-0">
                            ¬© {% now "Y" %} CGVargas Inform√°tica. Todos os direitos reservados.
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="credits mb-0">
                            Desenvolvido com <i class="bi bi-heart-fill text-danger"></i> por CGVargas Team
                        </p>
                    </div>
                </div>
            </div>
        </footer>
    </main>

<!-- Modal para detalhes de livros externos -->
<div id="externalBookModal" class="modal-container">
  <div class="modal-content max-w-lg">
    <div class="relative">
      <button id="closeExternalModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="p-6">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-shrink-0 w-full md:w-1/3">
          <img id="externalBookCover" src="" alt="Capa do livro" class="w-full object-cover rounded shadow-md" onerror="this.src='{% static 'images/no-cover.svg' %}'">
          <div class="mt-2 text-center">
            <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Google Books</span>
          </div>
        </div>

        <div class="flex-grow">
          <h3 id="externalBookTitle" class="text-xl font-bold mb-2">Carregando...</h3>
          <p id="externalBookAuthor" class="text-gray-700 mb-2">Autor: <span>Carregando...</span></p>
          <p id="externalBookCategories" class="text-gray-700 mb-2">Categoria: <span>-</span></p>
          <p id="externalBookPublisher" class="text-gray-700 mb-1">Editora: <span>-</span></p>
          <p id="externalBookYear" class="text-gray-700 mb-1">Ano: <span>-</span></p>
          <p id="externalBookPages" class="text-gray-700 mb-4">P√°ginas: <span>-</span></p>

          <div id="externalBookDescription" class="text-gray-600 mb-4 max-h-32 overflow-y-auto text-sm">
            Carregando descri√ß√£o...
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-col space-y-2">
        <div class="flex justify-end gap-2">
          <button id="addExternalBookToShelf" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
            Adicionar √† minha prateleira
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para selecionar prateleira -->
<div id="shelfSelectionModal" class="modal-container">
  <div class="modal-content max-w-md">
    <div class="p-6">
      <h3 class="text-xl font-bold mb-4">Selecionar prateleira</h3>
      <p class="text-gray-600 mb-4">Em qual prateleira voc√™ deseja adicionar este livro?</p>

      <div class="space-y-3 mb-6">
        <button data-shelf="lendo" class="shelf-option w-full py-2 px-4 border border-gray-300 rounded text-left hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <span class="font-medium">Lendo agora</span>
          <span class="block text-sm text-gray-500">Livros que estou lendo atualmente</span>
        </button>

        <button data-shelf="vou_ler" class="shelf-option w-full py-2 px-4 border border-gray-300 rounded text-left hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <span class="font-medium">Vou ler</span>
          <span class="block text-sm text-gray-500">Livros que pretendo ler no futuro</span>
        </button>

        <button data-shelf="lido" class="shelf-option w-full py-2 px-4 border border-gray-300 rounded text-left hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <span class="font-medium">J√° li</span>
          <span class="block text-sm text-gray-500">Livros que j√° terminei de ler</span>
        </button>

        <button data-shelf="favorito" class="shelf-option w-full py-2 px-4 border border-gray-300 rounded text-left hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <span class="font-medium">Favoritos</span>
          <span class="block text-sm text-gray-500">Meus livros favoritos</span>
        </button>
      </div>

      <div class="flex justify-end gap-2">
        <button id="cancelShelfSelection" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
          Cancelar
        </button>
        <button id="confirmShelfSelection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<div id="cookie-banner" class="fixed-bottom bg-dark text-white p-3 shadow-lg d-none" style="z-index: 9999;">
  <div class="container d-flex justify-content-between align-items-center flex-column flex-md-row text-center text-md-start">
    <span>
      Utilizamos cookies para melhorar sua experi√™ncia. Ao continuar navegando, voc√™ concorda com nossa
      <a href="{% url 'core:politica_privacidade' %}" class="text-warning text-decoration-underline">Pol√≠tica de Privacidade</a>.
    </span>
    <button id="accept-cookies" class="btn btn-warning mt-3 mt-md-0">Aceitar</button>
  </div>
</div>

<!-- Modal de Customiza√ß√£o do Card -->
<div class="modal fade" id="customizeCardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Personalizar Card do Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cardCustomizationForm">
                    <div class="mb-3">
                        <label class="form-label">Temas Predefinidos</label>
                        <select class="form-select" id="style_preset">
                            <option value="custom">Personalizado</option>
                            <option value="classic">Cl√°ssico</option>
                            <option value="dark">Escuro</option>
                            <option value="minimalist">Minimalista</option>
                            <option value="vibrant">Vibrante</option>
                        </select>
                    </div>

                    <hr class="my-3">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Cor de Fundo</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-palette"></i></span>
                                <input type="color" class="form-control form-control-color" id="style_background_color">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Cor do Texto</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-type"></i></span>
                                <input type="color" class="form-control form-control-color" id="style_text_color">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Cor da Borda</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-border"></i></span>
                                <input type="color" class="form-control form-control-color" id="style_border_color">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Estilo da Imagem</label>
                            <select class="form-select" id="style_image_style">
                                <option value="circle">Circular</option>
                                <option value="square">Quadrado</option>
                                <option value="hexagon">Hex√°gono</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Efeito Hover</label>
                            <select class="form-select" id="style_hover_effect">
                                <option value="translate">Eleva√ß√£o</option>
                                <option value="scale">Escala</option>
                                <option value="glow">Brilho</option>
                                <option value="none">Nenhum</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">
                                <label class="form-label">Estilo dos √çcones</label>
                            <select class="form-select" id="style_icon_style">
                                <option value="default">Padr√£o</option>
                                <option value="filled">Preenchido</option>
                                <option value="outline">Contorno</option>
                                <option value="minimal">Minimalista</option>
                            </select>
                            </label>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Raio da Borda</label>
                            <select class="form-select" id="style_border_radius">
                                <option value="0">Sem arredondamento</option>
                                <option value="0.25rem">Suave</option>
                                <option value="0.5rem">M√©dio</option>
                                <option value="1rem">Grande</option>
                                <option value="2rem">Extra Grande</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Estilo da Sombra</label>
                            <select class="form-select" id="style_shadow_style">
                                <option value="none">Nenhuma</option>
                                <option value="light">Suave</option>
                                <option value="medium">M√©dia</option>
                                <option value="dark">Forte</option>
                                <option value="colored">Colorida</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="cancelCustomizationBtn" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCardCustomization()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Mover Livro -->
<div class="modal fade" id="moveBookModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-bottom-0 bg-dark text-white rounded-top-4">
                <h5 class="modal-title">Mover para Outra Prateleira</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="moveBookForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Selecione a Nova Prateleira</label>
                        <select class="form-select" name="new_shelf">
                            <option value="favorito" {% if shelf == 'favorito' %}disabled{% endif %}>
                                ‚≠ê Favoritos
                            </option>
                            <option value="lendo" {% if shelf == 'lendo' %}disabled{% endif %}>
                                üìñ Lendo
                            </option>
                            <option value="vou_ler" {% if shelf == 'vou_ler' %}disabled{% endif %}>
                                üìö Quero Ler
                            </option>
                            <option value="lido" {% if shelf == 'lido' %}disabled{% endif %}>
                                ‚úÖ Lido
                            </option>
                        </select>
                        <small class="form-text">
                            Escolha a prateleira para onde deseja mover este livro.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary close-modal" data-bs-dismiss="modal" id="cancelMoveButton">
                    Cancelar
                </button>
                <!-- REMO√á√ÉO DO ONCLICK - ser√° gerenciado via event listener -->
                <button type="button" class="btn btn-primary" id="confirmMoveButton" data-action="move-book">
                    <i class="bi bi-arrow-right-circle"></i> Mover
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualiza√ß√£o da imagem completa -->
<div id="imageModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-bottom-0 bg-dark text-white rounded-top-4">
                <h5 class="modal-title">Visualizar Imagem</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 d-flex justify-content-center align-items-center">
                <img src="" id="modalImage" alt="Capa em tamanho completo" class="img-fluid">
            </div>
            <div class="modal-footer border-top-0 justify-content-center">
                <button type="button" class="btn btn-secondary close-modal" data-bs-dismiss="modal">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para adicionar √† prateleira -->
<div class="modal fade" id="addToShelfModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-bottom-0 bg-dark text-white rounded-top-4">
                <h5 class="modal-title">Adicionar √† Prateleira</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addToShelfForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Selecione a Prateleira</label>
                        <select class="form-select" name="shelf_type">
                            <option value="favorito">Favoritos</option>
                            <option value="lendo">Lendo</option>
                            <option value="vou_ler">Quero Ler</option>
                            <option value="lido">Lido</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary close-modal" data-bs-dismiss="modal" id="cancelShelfButton">Cancelar</button>
                <!-- REMO√á√ÉO DO ONCLICK - ser√° gerenciado via event listener -->
                <button type="button" class="btn btn-primary" id="confirmAddButton" data-action="add-to-shelf">
                   <i class="bi bi-bookmark-plus"></i> Adicionar √† Prateleira
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Atualiza√ß√£o de Progresso (Atualizado) -->
<div class="modal fade" id="updateProgressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Atualizar Progresso de Leitura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="updateProgressForm">
                    {% csrf_token %}
                    <input type="hidden" id="bookId" name="book_id">

                    <div class="mb-3">
                        <label for="bookTitle" class="form-label">Livro</label>
                        <input type="text" class="form-control" id="bookTitle" disabled>
                    </div>

                    <div class="mb-3">
                        <label for="currentPage" class="form-label">P√°gina Atual</label>
                        <input type="number" class="form-control" id="currentPage" name="current_page" min="1" required>
                        <div class="form-text" id="totalPagesText"></div>
                    </div>

                    <div class="mb-3">
                        <label for="startedAt" class="form-label">Data de In√≠cio</label>
                        <input type="date" class="form-control" id="startedAt" name="started_at" required>
                        <div class="form-text">Data em que iniciou a leitura</div>
                    </div>

                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" id="progressBar"
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="markAsFinished" name="mark_as_finished">
                        <label class="form-check-label" for="markAsFinished">Marcar como conclu√≠do</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary save-progress-btn">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Estat√≠sticas Detalhadas (V2) -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statsModalLabel"><i class="bi bi-bar-chart-line-fill me-2"></i>Estat√≠sticas de Leitura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body stats-modal-body">
                <!-- O conte√∫do ser√° preenchido pelo JavaScript -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<!-- SCRIPTS PRINCIPAIS EM ORDEM ESPEC√çFICA -->

<!-- 1. JQUERY - PRIMEIRO -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- 2. POPPER.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js"></script>

<!-- 3. BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- 4. SWIPER -->
<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>

<!-- 5. CONFIGURA√á√ïES B√ÅSICAS -->
<script src="{% static 'js/csrf-setup.js' %}"></script>

<!-- 6. SCRIPTS ESPEC√çFICOS DA P√ÅGINA -->
{% if request.path == '/profile/' %}
    <!-- Scripts apenas para a p√°gina de perfil -->
    <script src="{% static 'js/profile.js' %}"></script>
{% else %}
    <!-- Scripts para outras p√°ginas -->
{% endif %}

<!-- 7. SCRIPTS GLOBAIS -->
<script src="{% static 'js/theme-switcher.js' %}"></script>
<script src="{% static 'js/event-swiper-config.js' %}"></script>

<!-- 8. VERIFICA√á√ÉO DE RECURSOS CR√çTICOS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se recursos cr√≠ticos carregaram
    const criticalResources = {
        'jQuery': typeof jQuery !== 'undefined',
        'Bootstrap': typeof bootstrap !== 'undefined',
        'Popper': typeof Popper !== 'undefined'
    };

    const failed = Object.entries(criticalResources).filter(([name, loaded]) => !loaded);

    if (failed.length > 0) {
        console.error('Recursos cr√≠ticos falharam ao carregar:', failed.map(([name]) => name));

        // Tentar recarregar recursos cr√≠ticos
        failed.forEach(([name]) => {
            if (name === 'Bootstrap') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
                document.head.appendChild(script);
            }
        });
    } else {
        console.log('Todos os recursos cr√≠ticos carregaram corretamente');
    }

    // Inicializar tooltips e popovers apenas se Bootstrap estiver dispon√≠vel
    if (typeof bootstrap !== 'undefined') {
        // Tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Popovers
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });

        // Dropdowns
        const dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
        dropdownElementList.forEach(function(dropdownToggleEl) {
            new bootstrap.Dropdown(dropdownToggleEl);
        });

        console.log('Bootstrap components inicializados:', {
            tooltips: tooltipTriggerList.length,
            popovers: popoverTriggerList.length,
            dropdowns: dropdownElementList.length
        });
    }
});

// Tratamento global de erros
window.addEventListener('error', function(e) {
    if (e.message.includes('message port') || e.message.includes('extension')) {
        return; // Ignorar erros de extens√µes
    }
    console.error('Erro global capturado:', e.message);
});
</script>

<!-- 9. NAVBAR MOBILE -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const navbarToggler = document.querySelector('.navbar-toggler');
    const navbarCollapse = document.querySelector('.navbar-collapse');

    if (navbarToggler && navbarCollapse) {
        navbarToggler.addEventListener('click', function() {
            if (typeof bootstrap !== 'undefined') {
                const bsCollapse = new bootstrap.Collapse(navbarCollapse, {
                    toggle: true
                });
            } else {
                navbarCollapse.classList.toggle('show');
            }
        });
    }
});
</script>

<!-- 10. COOKIES -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch("{% url 'core:aceitar_cookies' %}")
      .then(response => response.json())
      .then(data => {
        if (!data.cookie_consent) {
          document.getElementById("cookie-banner").classList.remove("d-none");
        }
      });

    document.getElementById("accept-cookies").addEventListener("click", function () {
      fetch("{% url 'core:aceitar_cookies' %}", { method: 'GET' })
        .then(() => document.getElementById("cookie-banner").classList.add("d-none"));
    });
  });
</script>
{% endblock %}

<!-- SCRIPTS FINAIS -->
<script src="{% static 'js/image-fallback-improved.js' %}"></script>
<script src="{% static 'js/book-recommendation-fix.js' %}"></script>

</body>
</html>