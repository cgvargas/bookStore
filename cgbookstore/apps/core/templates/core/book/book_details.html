{% extends 'core/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ book.titulo }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book-details.css' %}">
<link rel="stylesheet" href="{% static 'css/book-details-background.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'core:index' %}">Página Inicial</a></li>
            {% if shelf %}
            <li class="breadcrumb-item"><a href="{% url 'core:profile' %}#{{ shelf }}">{{ shelf_display }}</a></li>
            {% elif is_from_recommendation %}
            <li class="breadcrumb-item"><a href="{% url 'core:recommendations' %}">Recomendações</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ book.titulo }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="book-cover-container">
                    <img src="{{ book.get_preview_url }}"
                         alt="Capa do livro {{ book.titulo }}"
                         class="book-cover img-fluid"
                         data-full-image="{{ book.get_capa_url }}"
                         onclick="showFullImage(this)"
                         loading="lazy"
                         onerror="this.onerror=null; this.src='{% static 'images/no-cover.svg' %}';">
                </div>
                <div class="card-body">
                    <div class="book-price text-center mb-3">
                        {% if book.preco %}
                            <h3 class="price">
                                {% if book.preco_promocional %}
                                    <span class="original-price">R$ {{ book.preco|floatformat:2 }}</span>
                                    <span class="promotional-price">R$ {{ book.preco_promocional|floatformat:2 }}</span>
                                {% else %}
                                    <span>R$ {{ book.preco|floatformat:2 }}</span>
                                {% endif %}
                            </h3>
                        {% endif %}
                    </div>
                    <div class="action-buttons d-grid gap-2">
                        {% if book.preco %}
                            <button class="btn btn-primary btn-lg" onclick="handleBuyBook()">
                                <i class="bi bi-cart"></i> Comprar
                            </button>
                        {% endif %}
                    </div>
                </div>

                {% if book.id %}
                    {% comment %} Este bloco só aparece se o livro EXISTE no nosso banco de dados {% endcomment %}
                    {% if shelf %}
                        <!-- Livro já está em uma prateleira do usuário -->
                        <div class="card-body">
                            <div class="shelf-badge mb-3">
                                <span class="badge bg-success">{{ shelf_display }}</span>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="window.openMoveModal && window.openMoveModal()">
                                    <i class="bi bi-arrows-move"></i> Mover
                                </button>
                                <a href="{% url 'core:book_edit' book.id %}" class="btn btn-outline-secondary d-flex justify-content-center align-items-center">
                                    <i class="bi bi-pencil"></i> Editar Livro
                                </a>
                                <button class="btn btn-outline-danger" onclick="window.confirmRemove && window.confirmRemove()">
                                    <i class="bi bi-trash"></i> Remover
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <!-- Livro existe no banco mas não está na prateleira do usuário -->
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="window.openShelfModal && window.openShelfModal()">
                                    <i class="bi bi-bookmark-plus"></i> Adicionar à Prateleira
                                </button>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    {% comment %} Este bloco aparece se for um livro externo, ainda não adicionado {% endcomment %}
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="window.openShelfModal && window.openShelfModal()">
                                <i class="bi bi-bookmark-plus"></i> Adicionar à Minha Estante
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="col-md-8">
            <div class="book-details"
                 data-book-id="{{ book.id }}"
                 data-external-id="{{ book.external_id }}"
                 data-current-shelf="{{ shelf }}">
                <ul class="nav nav-tabs" id="bookTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#basic" type="button">
                            <i class="bi bi-info-circle"></i> Informações Básicas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#content" type="button">
                            <i class="bi bi-book"></i> Conteúdo
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#extra" type="button">
                            <i class="bi bi-plus-circle"></i> Extras
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-4" id="bookTabsContent">
                    <div class="tab-pane fade show active" id="basic">
                        <h1 class="book-title mb-3">{{ book.titulo }}</h1>
                        {% if book.subtitulo %}
                        <h4 class="book-subtitle text-muted mb-4">{{ book.subtitulo }}</h4>
                        {% endif %}

                        <div class="info-grid">
                            {% if book.autor %}
                            <div class="info-item">
                                <strong>Autor:</strong> {{ book.autor }}
                            </div>
                            {% endif %}

                            {% if book.tradutor %}
                            <div class="info-item">
                                <strong>Tradutor:</strong> {{ book.tradutor }}
                            </div>
                            {% endif %}

                            {% if book.ilustrador %}
                            <div class="info-item">
                                <strong>Ilustrador:</strong> {{ book.ilustrador }}
                            </div>
                            {% endif %}

                            {% if book.editora %}
                            <div class="info-item">
                                <strong>Editora:</strong> {{ book.editora }}
                            </div>
                            {% endif %}

                            {% if book.isbn %}
                            <div class="info-item">
                                <strong>ISBN:</strong> {{ book.isbn }}
                            </div>
                            {% endif %}

                            {% if book.edicao %}
                            <div class="info-item">
                                <strong>Edição:</strong> {{ book.edicao }}
                            </div>
                            {% endif %}

                            {% if book.data_publicacao %}
                            <div class="info-item">
                                <strong>Publicação:</strong> {{ book.data_publicacao|date:"d/m/Y" }}
                            </div>
                            {% endif %}

                            {% if book.numero_paginas %}
                            <div class="info-item">
                                <strong>Páginas:</strong> {{ book.numero_paginas }}
                            </div>
                            {% endif %}

                            {% if book.idioma %}
                            <div class="info-item">
                                <strong>Idioma:</strong> {{ book.idioma }}
                            </div>
                            {% endif %}

                            {% if book.formato %}
                            <div class="info-item">
                                <strong>Formato:</strong> {{ book.formato }}
                            </div>
                            {% endif %}

                            {% if book.dimensoes %}
                            <div class="info-item">
                                <strong>Dimensões:</strong> {{ book.dimensoes }}
                            </div>
                            {% endif %}

                            {% if book.peso %}
                            <div class="info-item">
                                <strong>Peso:</strong> {{ book.peso }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="content">
                        {% if book.descricao %}
                        <div class="content-section mb-4">
                            <h3>Sinopse</h3>
                            <div class="content-text">{{ book.descricao|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.genero %}
                        <div class="content-section mb-4">
                            <h3>Gênero Literário</h3>
                            <div class="content-text">{{ book.genero }}</div>
                        </div>
                        {% endif %}

                        {% if book.temas %}
                        <div class="content-section mb-4">
                            <h3>Temas</h3>
                            <div class="content-text">{{ book.temas|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.personagens %}
                        <div class="content-section mb-4">
                            <h3>Personagens Principais</h3>
                            <div class="content-text">{{ book.personagens|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.enredo %}
                        <div class="content-section mb-4">
                            <h3>Enredo</h3>
                            <div class="content-text">{{ book.enredo|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.publico_alvo %}
                        <div class="content-section mb-4">
                            <h3>Público-alvo</h3>
                            <div class="content-text">{{ book.publico_alvo }}</div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Extras -->
                    <div class="tab-pane fade" id="extra">
                        {% if book.premios %}
                        <div class="extra-section mb-4">
                            <h3>Prêmios</h3>
                            <div class="extra-text">{{ book.premios|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.adaptacoes %}
                        <div class="extra-section mb-4">
                            <h3>Adaptações</h3>
                            <div class="extra-text">{{ book.adaptacoes|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.colecao %}
                        <div class="extra-section mb-4">
                            <h3>Coleção</h3>
                            <div class="extra-text">{{ book.colecao }}</div>
                        </div>
                        {% endif %}

                        {% if book.classificacao %}
                        <div class="extra-section mb-4">
                            <h3>Classificação Indicativa</h3>
                            <div class="extra-text">{{ book.classificacao }}</div>
                        </div>
                        {% endif %}

                        {% if book.prefacio %}
                        <div class="extra-section mb-4">
                            <h3>Prefácio/Introdução</h3>
                            <div class="extra-text">{{ book.prefacio|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.posfacio %}
                        <div class="extra-section mb-4">
                            <h3>Posfácio</h3>
                            <div class="extra-text">{{ book.posfacio|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.notas %}
                        <div class="extra-section mb-4">
                            <h3>Notas de Rodapé</h3>
                            <div class="extra-text">{{ book.notas|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.bibliografia %}
                        <div class="extra-section mb-4">
                            <h3>Bibliografia</h3>
                            <div class="extra-text">{{ book.bibliografia|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.indice %}
                        <div class="extra-section mb-4">
                            <h3>Índice</h3>
                            <div class="extra-text">{{ book.indice|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.glossario %}
                        <div class="extra-section mb-4">
                            <h3>Glossário</h3>
                            <div class="extra-text">{{ book.glossario|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.apendices %}
                        <div class="extra-section mb-4">
                            <h3>Apêndices</h3>
                            <div class="extra-text">{{ book.apendices|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.citacoes %}
                        <div class="extra-section mb-4">
                            <h3>Citações Marcantes</h3>
                            <div class="extra-text">{{ book.citacoes|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.curiosidades %}
                        <div class="extra-section mb-4">
                            <h3>Curiosidades</h3>
                            <div class="extra-text">{{ book.curiosidades|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if book.website %}
                        <div class="extra-section mb-4">
                            <h3>Website</h3>
                            <div class="extra-text">
                                <a href="{{ book.website }}" target="_blank" rel="noopener noreferrer">
                                    {{ book.website }}
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        {% if book.redes_sociais %}
                        <div class="extra-section mb-4">
                            <h3>Redes Sociais</h3>
                            <div class="extra-text">
                                {% for rede, link in book.redes_sociais.items %}
                                <div class="mb-2">
                                    <strong>{{ rede|title }}:</strong>
                                    <a href="{{ link }}" target="_blank" rel="noopener noreferrer">
                                        {{ link }}
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para manipulação do modal de imagem -->
<script>
function showFullImage(previewImg) {
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    const modalImg = document.getElementById('modalImage');

    // Usar a imagem original em alta qualidade
    modalImg.src = previewImg.dataset.fullImage || previewImg.src;

    // Garantir que a imagem carregue antes de mostrar o modal
    modalImg.onload = function() {
        // Remover qualquer restrição de tamanho que possa ter sido aplicada
        this.style.maxWidth = 'none';
        this.style.maxHeight = '80vh';
        modal.show();
    };
}
</script>

<script>
console.log('Book ID no template:', '{{ book.id }}');
console.log('Shelf:', '{{ shelf }}');
</script>

<script>
/**
 * Garante que o tema seja aplicado corretamente em todos os elementos
 */

(function() {
    'use strict';

    /**
     * Classe para gerenciamento de tema na página de detalhes
     */
    class BookDetailsThemeManager {
        constructor() {
            this.currentTheme = null;
            this.observer = null;
            this.init();
        }

        /**
         * Inicializa o gerenciador de tema
         */
        init() {
            console.log('Inicializando BookDetailsThemeManager');

            // Aplica tema inicial
            this.applyInitialTheme();

            // Configura observadores
            this.setupThemeObserver();

            // Força aplicação após DOM carregado
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    this.forceThemeApplication();
                });
            } else {
                this.forceThemeApplication();
            }

            // Aplica tema periodicamente para garantir consistência
            setTimeout(() => this.forceThemeApplication(), 500);
            setTimeout(() => this.forceThemeApplication(), 1000);
        }

        /**
         * Aplica o tema inicial baseado no localStorage ou preferência do sistema
         */
        applyInitialTheme() {
            try {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (prefersDark ? 'dark' : 'light');

                console.log('Aplicando tema inicial:', theme);
                this.setTheme(theme);
            } catch (error) {
                console.warn('Erro ao aplicar tema inicial:', error);
                this.setTheme('light');
            }
        }

        /**
         * Define o tema atual
         */
        setTheme(theme) {
            if (theme === this.currentTheme) return;

            console.log('Mudando tema para:', theme);
            this.currentTheme = theme;

            // Remove classes antigas
            document.documentElement.classList.remove('light-mode', 'dark-mode');
            document.body.classList.remove('light-mode', 'dark-mode');

            // Remove atributos antigos
            document.documentElement.removeAttribute('data-bs-theme');
            document.documentElement.removeAttribute('data-theme');

            // Aplica novo tema
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.classList.add(`${theme}-mode`);
            document.body.classList.add(`${theme}-mode`);

            // Para compatibilidade com Bootstrap
            document.documentElement.setAttribute('data-bs-theme', theme);

            // Força atualização de estilos
            this.forceStyleUpdate();

            // Salva preferência
            try {
                localStorage.setItem('theme', theme);
            } catch (error) {
                console.warn('Erro ao salvar tema:', error);
            }
        }

        /**
         * Força atualização de estilos em elementos específicos
         */
        forceStyleUpdate() {
            // Lista de seletores para forçar atualização
            const selectors = [
                '.card',
                '.book-cover-container',
                '.book-details',
                '.info-item',
                '.content-section',
                '.extra-section',
                '.nav-tabs .nav-link',
                '.modal-content',
                '.form-control',
                '.form-select'
            ];

            selectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    // Força repaint
                    element.style.display = 'none';
                    element.offsetHeight; // trigger reflow
                    element.style.display = '';
                });
            });
        }

        /**
         * Força aplicação completa do tema
         */
        forceThemeApplication() {
            console.log('Forçando aplicação do tema:', this.currentTheme);

            // Força aplicação em elementos específicos problemáticos
            this.fixSpecificElements();

            // Corrige modais
            this.fixModals();

            // Corrige formulários
            this.fixForms();

            // Emite evento personalizado
            this.dispatchThemeEvent();
        }

        /**
         * Corrige elementos específicos que podem ter problemas de tema
         */
        fixSpecificElements() {
            // Cards
            const cards = document.querySelectorAll('.card, .book-cover-container');
            cards.forEach(card => {
                if (this.currentTheme === 'dark') {
                    card.style.backgroundColor = 'rgba(43, 48, 53, 0.95)';
                    card.style.color = '#f8f9fa';
                    card.style.borderColor = '#495057';
                } else {
                    card.style.backgroundColor = 'rgba(255, 255, 255, 0.85)';
                    card.style.color = '#212529';
                    card.style.borderColor = '#dee2e6';
                }
            });

            // Títulos
            const titles = document.querySelectorAll('.book-title, h1, h2, h3, h4, h5, h6');
            titles.forEach(title => {
                title.style.color = this.currentTheme === 'dark' ? '#f8f9fa' : '#212529';
            });

            // Textos secundários
            const secondaryTexts = document.querySelectorAll('.book-subtitle, .text-muted');
            secondaryTexts.forEach(text => {
                text.style.color = this.currentTheme === 'dark' ? '#adb5bd' : '#6c757d';
            });

            // Info items
            const infoItems = document.querySelectorAll('.info-item');
            infoItems.forEach(item => {
                if (this.currentTheme === 'dark') {
                    item.style.backgroundColor = 'rgba(30, 30, 30, 0.95)';
                    item.style.color = '#f8f9fa';
                } else {
                    item.style.backgroundColor = 'rgba(248, 249, 250, 0.7)';
                    item.style.color = '#212529';
                }
            });
        }

        /**
         * Corrige modais para o tema atual
         */
        fixModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.classList.remove('light-theme', 'dark-theme');
                modal.classList.add(`${this.currentTheme}-theme`);
            });
        }

        /**
         * Corrige formulários para o tema atual
         */
        fixForms() {
            const formControls = document.querySelectorAll('.form-control, .form-select');
            formControls.forEach(control => {
                if (this.currentTheme === 'dark') {
                    control.style.backgroundColor = 'rgba(43, 48, 53, 0.95)';
                    control.style.color = '#f8f9fa';
                    control.style.borderColor = '#495057';
                } else {
                    control.style.backgroundColor = '#ffffff';
                    control.style.color = '#212529';
                    control.style.borderColor = '#dee2e6';
                }
            });
        }

        /**
         * Configura observador para mudanças de tema
         */
        setupThemeObserver() {
            // Observa mudanças no atributo data-theme
            this.observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' &&
                        (mutation.attributeName === 'data-theme' ||
                         mutation.attributeName === 'class')) {

                        const newTheme = document.documentElement.getAttribute('data-theme');
                        if (newTheme && newTheme !== this.currentTheme) {
                            console.log('Tema detectado via observador:', newTheme);
                            this.currentTheme = newTheme;
                            this.forceThemeApplication();
                        }
                    }
                });
            });

            this.observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-theme', 'class']
            });

            // Observa mudanças no localStorage
            window.addEventListener('storage', (e) => {
                if (e.key === 'theme') {
                    console.log('Tema alterado via storage:', e.newValue);
                    this.setTheme(e.newValue);
                }
            });
        }

        /**
         * Emite evento personalizado quando tema muda
         */
        dispatchThemeEvent() {
            const event = new CustomEvent('bookDetailsThemeChanged', {
                detail: { theme: this.currentTheme }
            });
            document.dispatchEvent(event);
        }

        /**
         * Destrói o gerenciador
         */
        destroy() {
            if (this.observer) {
                this.observer.disconnect();
                this.observer = null;
            }
        }

        /**
         * Método público para alternar tema
         */
        toggleTheme() {
            const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
            this.setTheme(newTheme);
        }

        /**
         * Método público para obter tema atual
         */
        getCurrentTheme() {
            return this.currentTheme;
        }
    }

    /**
     * Função de utilidade para aplicar correções de emergência
     */
    function emergencyThemeFix() {
        const theme = document.documentElement.getAttribute('data-theme') || 'light';

        // Força fundo do body
        document.body.style.backgroundColor = theme === 'dark' ? '#121212' : '#ffffff';
        document.body.style.color = theme === 'dark' ? '#f8f9fa' : '#212529';

        // Força cards
        const cards = document.querySelectorAll('.card, .book-cover-container');
        cards.forEach(card => {
            card.style.backgroundColor = theme === 'dark' ?
                'rgba(43, 48, 53, 0.95)' : 'rgba(255, 255, 255, 0.85)';
            card.style.color = theme === 'dark' ? '#f8f9fa' : '#212529';
        });

        console.log('Correção de emergência aplicada para tema:', theme);
    }

    let themeManager = null;

    function initializeThemeManager() {
        if (!themeManager) {
            themeManager = new BookDetailsThemeManager();

            // Disponibiliza globalmente para debug
            window.bookDetailsThemeManager = themeManager;
            window.emergencyThemeFix = emergencyThemeFix;

            console.log('BookDetailsThemeManager inicializado e disponível globalmente');
        }
        return themeManager;
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeThemeManager);
    } else {
        initializeThemeManager();
    }

    setTimeout(() => {
        if (!themeManager) {
            console.warn('ThemeManager não inicializado, aplicando correção de emergência');
            emergencyThemeFix();
            initializeThemeManager();
        }
    }, 2000);

    document.addEventListener('themeChanged', function(e) {
        if (themeManager && e.detail && e.detail.theme) {
            console.log('Tema alterado via evento global:', e.detail.theme);
            themeManager.setTheme(e.detail.theme);
        }
    });

})();
</script>

{% endblock %}

{{% block extra_js %}
    {{ block.super }}

    <!-- SCRIPT CORRIGIDO PARA DADOS DO LIVRO -->
    <script id="book-data" type="application/json">
    {% if book_json %}
        {{ book_json|safe }}
    {% else %}
        {
            "id": {% if book.id %}"{{ book.id }}"{% else %}null{% endif %},
            "titulo": "{{ book.titulo|escapejs }}",
            "autor": "{{ book.autor|escapejs }}",
            "external_id": {% if book.external_id %}"{{ book.external_id }}"{% else %}null{% endif %},
            "current_shelf": {% if shelf %}"{{ shelf }}"{% else %}null{% endif %},
            "capa_url": "{{ book.get_preview_url|escapejs }}",
            "descricao": "{{ book.descricao|escapejs|truncatewords:50 }}"
        }
    {% endif %}
    </script>

    <!-- DADOS ALTERNATIVOS PARA JAVASCRIPT -->
    <script>
        window.bookId = {% if book.id %}"{{ book.id }}"{% else %}null{% endif %};
        window.bookShelf = {% if shelf %}"{{ shelf }}"{% else %}null{% endif %};
        window.bookExternalId = {% if book.external_id %}"{{ book.external_id }}"{% else %}null{% endif %};
    </script>

    <!-- SCRIPT PRINCIPAL E ÚNICO PARA A LÓGICA DOS MODAIS -->
    <script src="{% static 'js/book-details.js' %}"></script>

    <script>
        function handleBuyBook() {
            alert('Funcionalidade de compra em desenvolvimento!');
        }
    </script>

{% endblock %}