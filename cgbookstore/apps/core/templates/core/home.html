{% extends 'core/base.html' %}
{% load static %}

{% block body_class %}page-home{% endblock %}

{% load custom_tags %}

{% block title %}Página Inicial{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css">
<link rel="stylesheet" href="{% static 'css/swiper-custom.css' %}">
<link rel="stylesheet" href="{% static 'css/custom_sections.css' %}">
<link rel="stylesheet" href="{% static 'css/video-section.css' %}">
<link rel="stylesheet" href="{% static 'css/author-section.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/ranking.css' %}">
{% endblock %}

{% block content %}
<div class="row">
    <!-- Coluna lateral para eventos -->
    <div class="col-lg-2 mb-4">
        {% include 'core/_event_widget.html' %}
    </div>

    <!-- Conteúdo principal -->
    <div class="col-lg-9">
        <!-- Banner Carousel -->
        {% if banners %}
        <div class="banner-carousel">
            <div class="swiper bannerSwiper">
                <div class="swiper-wrapper">
                    {% for banner in banners %}
                    <div class="swiper-slide">
                        <div class="banner-content">
                            <picture>
                                <source media="(max-width: 768px)" srcset="{{ banner.get_mobile_url }}" loading="lazy">
                                <img src="{{ banner.get_imagem_url }}" alt="{{ banner.titulo }}" class="banner-image" loading="lazy" decoding="async">
                            </picture>
                            {% if banner.titulo or banner.subtitulo or banner.descricao %}
                            <div class="banner-text">
                                <h2>{{ banner.titulo }}</h2>
                                {% if banner.subtitulo %}<h3>{{ banner.subtitulo }}</h3>{% endif %}
                                {% if banner.descricao %}<p>{{ banner.descricao }}</p>{% endif %}
                                {% if banner.link %}
                                <a href="{{ banner.link }}" class="btn btn-primary">Saiba mais</a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-pagination"></div>
            </div>
        </div>
        {% endif %}

        <!-- Novo componente de recomendações personalizadas -->
        {% if user.is_authenticated and has_mixed_recommendations %}
        <div class="mt-5">
            {% include 'core/components/recommendation_widget.html' %}
        </div>
        {% endif %}

        <!-- Seções da Home -->
        {% for section in shelves %}
            {% if section.tipo == 'shelf' and section.livros %}
            <!-- Prateleira de Livros -->
            <section class="book-shelf">
                <div class="container">
                    <h2 class="section-title animate-fade-in">{{ section.titulo }}</h2>
                    <div class="swiper bookSwiper">
                        <div class="swiper-wrapper">
                            {% for livro in section.livros %}
                            <div class="swiper-slide">
                                {% include 'core/includes/book_card.html' with livro=livro opcoes_prateleiras=opcoes_prateleiras %}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                </div>
            </section>
            {% endif %}

            {% if section.tipo == 'video' and section.videos %}
            <!-- Seção de Vídeo -->
            <section class="video-section {% if section.css_class %}{{ section.css_class }}{% endif %}" id="section-{{ section.id }}">
                <div class="container">
                    <h2 class="section-title">{{ section.titulo }}</h2>
                    <div class="swiper videoSwiper">
                        <div class="swiper-wrapper">
                            {% for video_item in section.videos %}
                            <div class="swiper-slide">
                                <div class="video-card">
                                    <div class="video-cover">
                                        {% if 'youtube.com' in video_item.url or 'youtu.be' in video_item.url %}
                                            {% with video_id=video_item.url|get_youtube_id %}
                                            <a href="https://www.youtube.com/watch?v={{ video_id }}" class="video-link" data-video-id="{{ video_id }}" target="_blank">
                                                <img src="https://img.youtube.com/vi/{{ video_id }}/hqdefault.jpg" alt="{{ video_item.titulo|default:'Vídeo YouTube' }}" class="video-thumbnail" loading="lazy" onerror="this.onerror=null; this.src='https://img.youtube.com/vi/{{ video_id }}/default.jpg';">
                                                <div class="play-overlay">
                                                    <span class="play-icon">▶</span>
                                                </div>
                                            </a>
                                            {% endwith %}
                                        {% endif %}
                                    </div>
                                    {% if video_item.titulo %}
                                    <h3 class="video-title">{{ video_item.titulo }}</h3>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                </div>
                <!-- ANOTAÇÃO: A estrutura do modal foi movida para fora do loop 'for' -->
            </section>
            {% endif %}

            {% if section.tipo == 'author' and section.authors %}
            <!-- Seção de Autores (AGORA COM CARROSSEL) -->
            <section class="author-section {% if section.css_class %}{{ section.css_class }}{% endif %}" id="section-{{ section.id }}">
                <div class="container">
                    <h2 class="section-title">{{ section.titulo }}</h2>
                    {% if section.author_section.titulo_secundario %}
                    <p class="section-subtitle">{{ section.author_section.titulo_secundario }}</p>
                    {% endif %}
                    {% if section.author_section.descricao %}
                    <p class="section-description">{{ section.author_section.descricao }}</p>
                    {% endif %}

                    <!-- Estrutura do Swiper -->
                    <div class="swiper authorSwiper">
                        <div class="swiper-wrapper">
                            {% for author in section.authors %}
                            <!-- Cada autor agora é um swiper-slide -->
                            <div class="swiper-slide">
                                <a href="{% url 'core:authors:author-detail' author.slug %}" class="text-decoration-none d-block h-100">
                                    <div class="author-card">
                                        {% if author.foto %}
                                        <div class="author-photo">
                                            <img src="{{ author.foto.url }}" alt="{{ author.get_nome_completo }}" loading="lazy">
                                        </div>
                                        {% endif %}
                                        <div class="author-info">
                                            <h3 class="author-name">{{ author.get_nome_completo }}</h3>
                                            {% if author.nacionalidade %}
                                            <p class="author-nationality">{{ author.nacionalidade }}</p>
                                            {% endif %}
                                            {% if section.author_section.mostrar_biografia and author.biografia %}
                                            <p class="author-bio">{{ author.biografia|truncatewords:20 }}</p> {# Truncado um pouco para caber melhor no card #}
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        <!-- Botões de Navegação -->
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                </div>
            </section>
            {% endif %}

            {% if section.tipo == 'ad' and section.advertisement %}
            <!-- Área de Propaganda -->
            <section class="ad-section {% if section.css_class %}{{ section.css_class }}{% endif %}">
                <div class="container">
                    <a href="{{ section.advertisement.url }}" target="_blank" class="ad-link">
                        <img src="{{ section.advertisement.imagem.url }}" alt="{{ section.titulo }}" class="ad-image" loading="lazy">
                    </a>
                </div>
            </section>
            {% endif %}

            {% if section.tipo == 'link_grid' and section.links %}
            <!-- Grade de Links -->
            <section class="link-grid {% if section.css_class %}{{ section.css_class }}{% endif %}" id="section-{{ section.id }}">
                <div class="container">
                    <h2 class="section-title">{{ section.titulo }}</h2>
                    <div class="link-grid-container">
                        {% for link in section.links %}
                        <a href="{{ link.url }}" class="link-item">
                            <img src="{{ link.imagem.url }}" alt="{{ link.titulo }}" loading="lazy">
                            <span class="link-title">{{ link.titulo }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% endif %}
        {% endfor %}

        <!-- Seção: Ranking de Leitores -->
        {% if ranking_usuarios %}
        <section class="reader-ranking-section mt-5 py-4 bg-light rounded">
            <div class="container">
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <h2 class="section-title display-6 fw-bold">
                            <i class="bi bi-trophy-fill text-warning me-2"></i>Ranking de Leitores
                        </h2>
                        <p class="text-muted">Nossos leitores mais dedicados deste mês</p>
                    </div>
                </div>
                <div class="row justify-content-center">
                    {% for usuario in ranking_usuarios %}
                    <div class="col-md-4 mb-4">
                        <div class="card shadow h-100 border-0 ranking-card position-relative text-center">
                            {% if forloop.counter <= 3 %}
                            <div class="position-absolute top-0 start-50 translate-middle">
                                <span class="badge rounded-pill {% if forloop.counter == 1 %}bg-warning text-dark{% elif forloop.counter == 2 %}bg-secondary text-white{% else %}bg-danger text-white{% endif %} px-3 py-2 shadow">
                                    <i class="bi bi-trophy-fill me-1"></i>#{{ forloop.counter }}
                                </span>
                            </div>
                            {% endif %}
                            <div class="card-body text-center pt-5">
                                {% if usuario.profile and usuario.profile.avatar %}
                                    <img src="{{ usuario.profile.avatar.url }}" class="rounded-circle mb-3 border shadow-sm" width="90" height="90" style="object-fit: cover;" alt="Avatar de {{ usuario.get_full_name|default:usuario.username }}">
                                {% else %}
                                    <img src="{% static 'images/default-avatar.png' %}" class="rounded-circle mb-3 border shadow-sm" width="90" height="90" alt="Avatar padrão">
                                {% endif %}
                                <h5 class="card-title fw-bold mb-1">{{ usuario.get_full_name|default:usuario.username }}</h5>
                                <div class="d-flex justify-content-center align-items-center">
                                    <span class="badge bg-primary rounded-pill px-3 py-2 mt-2">
                                        <i class="bi bi-book me-1"></i>
                                        {{ usuario.livros_lidos }} livro{{ usuario.livros_lidos|pluralize }}
                                    </span>
                                </div>
                                <div class="progress mt-3" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {% widthratio usuario.livros_lidos 20 100 %}%;" aria-valuenow="{{ usuario.livros_lidos }}" aria-valuemin="0" aria-valuemax="20"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Modal de Vídeo (fora do loop) -->
                    <div id="videoModal" class="video-modal">
                        <div class="modal-content">
                            <!-- ANOTAÇÃO: O 'x' foi trocado por '&times;' para melhor visualização -->
                            <span class="close-modal">&times;</span>
                            <div class="video-container">
                                <div id="modalVideoPlayer"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    {% if user.is_authenticated %}
                    <a href="{% url 'core:ranking_leitores' %}" class="btn btn-outline-primary"><i class="bi bi-trophy me-1"></i>Ver mais</a>
                    {% else %}
                    <a href="{% url 'core:login' %}" class="btn btn-outline-primary"><i class="bi bi-box-arrow-in-right me-1"></i>Entrar para participar</a>
                    {% endif %}
                </div>
            </div>
        </section>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
<script src="{% static 'js/video-section.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function fixYoutubeThumbnails() {
        document.querySelectorAll('.video-thumbnail').forEach(function(img) {
            img.addEventListener('error', function() {
                const videoId = this.closest('.video-link').getAttribute('data-video-id');
                if (videoId) {
                    this.src = `https://img.youtube.com/vi/${videoId}/default.jpg`;
                }
            });
        });
    }
    setTimeout(fixYoutubeThumbnails, 500);

    new Swiper('.bannerSwiper', {
        loop: true,
        autoplay: { delay: 5000, disableOnInteraction: false },
        pagination: { el: '.swiper-pagination', clickable: true },
        navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
        effect: 'fade',
        fadeEffect: { crossFade: true }
    });

    document.querySelectorAll('.bookSwiper').forEach(function(element) {
        new Swiper(element, {
            slidesPerView: 2,
            spaceBetween: 20,
            navigation: {
                nextEl: element.querySelector('.swiper-button-next'),
                prevEl: element.querySelector('.swiper-button-prev'),
            },
            breakpoints: {
                640: { slidesPerView: 3, spaceBetween: 20 },
                768: { slidesPerView: 4, spaceBetween: 30 },
                1024: { slidesPerView: 5, spaceBetween: 30 },
            }
        });
    });

    // Adicionado o Swiper para a seção de vídeos
    new Swiper('.videoSwiper', {
        slidesPerView: 1,
        spaceBetween: 20,
        navigation: {
            nextEl: '.videoSwiper .swiper-button-next',
            prevEl: '.videoSwiper .swiper-button-prev',
        },
        breakpoints: {
            576: { slidesPerView: 2, spaceBetween: 20 },
            768: { slidesPerView: 3, spaceBetween: 30 },
            992: { slidesPerView: 4, spaceBetween: 30 },
        }
    });

    // ===== CARROSSEL DE AUTORES =====
    new Swiper('.authorSwiper', {
        slidesPerView: 1, // Começa com 1 slide em telas pequenas
        spaceBetween: 20,
        navigation: {
            nextEl: '.authorSwiper .swiper-button-next',
            prevEl: '.authorSwiper .swiper-button-prev',
        },
        breakpoints: {
            576: { slidesPerView: 2, spaceBetween: 20 },
            768: { slidesPerView: 3, spaceBetween: 30 },
            992: { slidesPerView: 4, spaceBetween: 30 }, // 4 autores em telas maiores
        }
    });

    document.body.addEventListener('click', function(e) {
        if (e.target.closest('.btn-add-to-shelf')) {
            const button = e.target.closest('.btn-add-to-shelf');
            const select = button.previousElementSibling;
            const bookId = select.dataset.bookId;
            const shelfType = select.value;

            if (!shelfType || shelfType === 'Adicionar à...') {
                alert('Por favor, selecione uma prateleira.');
                return;
            }

            // Você já tem uma função para adicionar à prateleira em book.py
            // que responde a uma requisição POST.
            // Aqui fazemos a chamada AJAX para essa URL.
            fetch(`/add-to-shelf/`, { // Verifique se esta é a URL correta
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // Django CSRF Token
                },
                body: JSON.stringify({
                    book_id: bookId,
                    shelf_type: shelfType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostre uma notificação de sucesso para o usuário
                    alert(data.message);
                } else {
                    // Mostre uma notificação de erro
                    alert('Erro: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                alert('Ocorreu um erro de comunicação com o servidor.');
            });
        }
    });
});
</script>

{% endblock %}