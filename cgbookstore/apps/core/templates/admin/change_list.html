{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/changelists.css' %}">
  {% if cl.formset %}
    <link rel="stylesheet" href="{% static 'admin/css/forms.css' %}">
  {% endif %}
  {% if cl.formset or action_form %}
    <script src="{% static 'admin/js/jquery.init.js' %}"></script>
    <script src="{% static 'admin/js/core.js' %}"></script>
    <script src="{% static 'admin/js/actions.js' %}"></script>
  {% endif %}
  {% if cl.formset %}
    {{ cl.formset.media }}
  {% endif %}
  {% if action_form %}
    {{ action_form.media }}
  {% endif %}

  <style>
    /* Container principal para área superior */
    .admin-toolbar {
      background: linear-gradient(135deg, #2B2B40 0%, #3e3e5c 100%);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #4d4d6b;
    }

    /* Layout flexbox para distribuição dos elementos */
    .toolbar-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    /* Seção de ações (lado esquerdo) */
    .actions-section {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 200px;
    }

    /* Seção de pesquisa e botão (lado direito) */
    .search-section {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    /* Estilo das ações */
    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 !important;
    }

    .actions select {
      background-color: #3e3e5c;
      border: 1px solid #4d4d6b;
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .actions button {
      background-color: #2196F3 !important;
      color: white !important;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .actions button:hover {
      background-color: #1976D2 !important;
    }

    .actions label {
      color: white;
      font-size: 13px;
      font-weight: 500;
    }

    /* Contador de selecionados */
    .action-counter {
      color: #ffffff;
      font-size: 13px;
      font-weight: 500;
      background-color: rgba(255,255,255,0.1);
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    /* Formulário de pesquisa */
    #changelist-search {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    #changelist-search input[type="text"] {
      background-color: #3e3e5c;
      border: 1px solid #4d4d6b;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      min-width: 200px;
    }

    #changelist-search input[type="text"]::placeholder {
      color: #bbb;
    }

    #changelist-search input[type="submit"] {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    #changelist-search input[type="submit"]:hover {
      background-color: #1976D2;
    }

    /* Botão adicionar melhorado */
    .custom-add-btn {
      background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .custom-add-btn:hover {
      background: linear-gradient(135deg, #E55A2B 0%, #E8851A 100%);
      color: white;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .custom-add-btn:before {
      content: "+";
      font-size: 16px;
      font-weight: bold;
    }

    /* Ocultar botão original */
    .object-tools {
      display: none;
    }

    /* Estilos da tabela e cabeçalhos */
    #result_list th,
    #changelist table th,
    .module thead th,
    .change-list table thead th,
    .dashboard-table thead th {
        background: #2B2B40 !important;
        background-image: none !important;
        color: white !important;
        padding: 12px 15px !important;
        text-align: center !important;
        border-radius: 0 !important;
    }

    #result_list thead th:first-child,
    #changelist table thead th:first-child {
        background: #2B2B40 !important;
    }

    /* Garante que links dentro do cabeçalho mantenham a cor branca */
    #result_list th a,
    #changelist table th a {
        color: white !important;
    }

    /* Zebra striping nas linhas da tabela */
    #result_list tbody tr:nth-child(even),
    #changelist table tbody tr:nth-child(even) {
        background-color: #f9f9f9 !important;
    }

    #result_list tbody tr:nth-child(even) td,
    #changelist table tbody tr:nth-child(even) td {
        background-color: #f9f9f9 !important;
    }

    #result_list tbody tr:nth-child(odd),
    #changelist table tbody tr:nth-child(odd) {
        background-color: #ffffff !important;
    }

    #result_list tbody tr:nth-child(odd) td,
    #changelist table tbody tr:nth-child(odd) td {
        background-color: #ffffff !important;
    }

    /* Corrigir cor das mensagens */
    .errornote {
      color: #721c24 !important;
      background-color: #f8d7da !important;
      border-color: #f5c6cb !important;
    }

    .messagelist li.success {
      background-color: #d4edda !important;
      color: #155724 !important;
      border-color: #c3e6cb !important;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .toolbar-content {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }

      .actions-section,
      .search-section {
        justify-content: center;
      }

      #changelist-search input[type="text"] {
        min-width: 150px;
      }
    }

    /* Melhorar hierarquia de data se presente */
    .xfull {
      margin: 10px 0;
    }
  </style>
{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-list{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=cl.opts.app_label %}">{% if cl.opts.app_label == 'core' %}Organizador{% else %}{{ cl.opts.app_config.verbose_name }}{% endif %}</a>
&rsaquo; {{ cl.opts.verbose_name_plural|capfirst }}
</div>
{% endblock %}
{% endif %}

{% block coltype %}{% endblock %}

{% block content %}
  <div id="content-main">
    {% block object-tools %}
        <ul class="object-tools" style="display: none;">
          {% block object-tools-items %}
            {% if has_add_permission %}
            <li>
              {% url cl.opts|admin_urlname:'add' as add_url %}
              <a href="{% add_preserved_filters add_url is_popup to_field %}" class="addlink">
                {% blocktranslate with cl.opts.verbose_name as name %}Add {{ name }}{% endblocktranslate %}
              </a>
            </li>
            {% endif %}
          {% endblock %}
        </ul>
    {% endblock %}

    {% if cl.formset and cl.formset.errors %}
        <p class="errornote">
        {% blocktranslate count errors=cl.formset.errors|length %}Please correct the error below.{% plural %}Please correct the errors below.{% endblocktranslate %}
        </p>
        {{ cl.formset.non_form_errors }}
    {% endif %}

    <div class="module{% if cl.has_filters %} filtered{% endif %}" id="changelist">

      <!-- Barra de ferramentas melhorada -->
      <div class="admin-toolbar">
        <div class="toolbar-content">
          <!-- Seção de ações (lado esquerdo) -->
          <div class="actions-section">
            {% if action_form and actions_on_top and cl.show_admin_actions %}
              {% admin_actions %}
            {% endif %}
          </div>

          <!-- Seção de pesquisa e botão (lado direito) -->
          <div class="search-section">
            {% block search %}{% search_form cl %}{% endblock %}
            {% if has_add_permission %}
              {% url cl.opts|admin_urlname:'add' as add_url %}
              <a href="{% add_preserved_filters add_url is_popup to_field %}" class="custom-add-btn">
                Adicionar
              </a>
            {% endif %}
          </div>
        </div>
      </div>

      {% block date_hierarchy %}{% if cl.date_hierarchy %}{% date_hierarchy cl %}{% endif %}{% endblock %}

      <form id="changelist-form" method="post"{% if cl.formset and cl.formset.is_multipart %} enctype="multipart/form-data"{% endif %} novalidate>{% csrf_token %}
      {% if cl.formset %}
        <div>{{ cl.formset.management_form }}</div>
      {% endif %}

      {% block result_list %}
          {% result_list cl %}
          {% if action_form and actions_on_bottom and cl.show_admin_actions %}{% admin_actions %}{% endif %}
      {% endblock %}
      {% block pagination %}{% pagination cl %}{% endblock %}
      </form>

      {% block filters %}
        {% if cl.has_filters %}
          <div id="changelist-filter">
            <h2>
                {% translate 'Filter' %}
                <span class="toggle-arrow"></span>
            </h2>
            <div class="filter-content">
                {% if cl.has_active_filters %}<h3 id="changelist-filter-clear">
                  <a href="{{ cl.clear_all_filters_qs }}">&#10006; {% translate "Clear all filters" %}</a>
                </h3>{% endif %}
                {% for spec in cl.filter_specs %}{% admin_list_filter cl spec %}{% endfor %}
            </div>
          </div>
        {% endif %}
      {% endblock %}
    </div>
  </div>

  <script>
    (function($) {
        $(document).ready(function() {
            // Gatilho para abrir/fechar o filtro
            $('#changelist-filter h2').on('click', function() {
                $(this).closest('#changelist-filter').toggleClass('filters-open');
            });

            // Lógica para o contador de ações
            function updateActionCounter() {
                const total = $('#result_list tbody .action-select').length;
                const checked = $('#result_list tbody .action-select:checked').length;
                const counter = $('.action-counter');

                if (counter.length === 0) {
                    $('.actions').append('<span class="action-counter">0 de 0 selecionados</span>');
                }

                $('.action-counter').text(checked + ' de ' + total + ' selecionados');
            }

            // Monitora cliques em checkboxes
            $('#changelist-form').on('change', 'input[type="checkbox"]', function() {
                updateActionCounter();
            });

            // Garantir que o JavaScript do Django Admin funcione
            if (typeof window.django !== 'undefined' && window.django.jQuery) {
                setTimeout(function() {
                    if (window.django.actions) {
                        window.django.actions.bindCheckboxes();
                    }
                }, 200);
            }

            updateActionCounter();
        });
    })(django.jQuery);
  </script>
{% endblock %}