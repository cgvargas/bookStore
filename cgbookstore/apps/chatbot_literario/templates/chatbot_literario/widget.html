{% load static %}
<div id="chatbot-widget" class="chatbot-widget">
    <button id="chatbot-toggle" class="chatbot-toggle" title="Assistente Liter√°rio">
        <i class="bi bi-chat-dots-fill"></i>
        <span class="notification-badge" id="notification-badge" style="display: none;">1</span>
    </button>

    <div id="chatbot-window" class="chatbot-window" style="display: none;">
        <div class="chatbot-header">
            <div class="d-flex align-items-center">
                <div class="chatbot-avatar">ü§ñ</div>
                <div class="chatbot-info">
                    <div class="chatbot-title">Assistente Liter√°rio</div>
                    <div class="chatbot-status">
                        {% if user.is_authenticated %}
                            Online ‚Ä¢ {{ personalization.user_name }}
                        {% else %}
                            Online ‚Ä¢ Visitante
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="chatbot-controls">
                {% if user.is_authenticated and personalization.personalization_enabled %}
                    <button class="btn-control" id="widget-personalization-indicator" title="Personaliza√ß√£o Ativa">
                        üé®
                    </button>
                {% endif %}
                <button class="btn-control" id="chatbot-minimize" title="Minimizar">
                    <i class="bi bi-dash"></i>
                </button>
                <button class="btn-control" id="chatbot-close" title="Fechar">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>

        <div id="widget-messages" class="chatbot-messages">
            {% for message in messages %}
                <div class="message {{ message.sender }}-message show">
                    <div class="message-content">
                        <div class="message-text">{{ message.content|linebreaksbr }}</div>
                        <div class="message-meta">
                            <span class="timestamp">{{ message.timestamp|time:"H:i" }}</span>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="welcome-message" style="display: none;">
                    <div class="text-center p-3">
                        <div class="mb-2" style="font-size: 2rem;">üëã</div>
                        <div class="fw-bold">Ol√°! Como posso ajudar?</div>
                        <small class="text-muted">
                            {% if user.is_authenticated %}
                                Suas respostas s√£o personalizadas baseadas no seu perfil!
                            {% else %}
                                Fa√ßa login para obter respostas personalizadas.
                            {% endif %}
                        </small>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if user.is_authenticated %}
        <div class="widget-quick-actions">
            <button class="quick-action-btn" data-action="get_recommendations" title="Recomenda√ß√µes">
                ‚≠ê
            </button>
            <button class="quick-action-btn" data-action="get_favorites" title="Favoritos">
                üìö
            </button>
            <button class="quick-action-btn" data-action="get_reading_progress" title="Progresso">
                üìä
            </button>
        </div>
        {% endif %}

        <div class="chatbot-input-area">
            <div class="input-group">
                <textarea
                    id="widget-input"
                    class="form-control"
                    placeholder="Digite sua pergunta..."
                    rows="1"
                    maxlength="500"
                ></textarea>
                <button id="widget-send" class="btn btn-primary" title="Enviar">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>

        <div class="chatbot-footer">
            <small class="text-muted">
                <a href="{% url 'chatbot_literario:chatbot_view' %}" target="_blank" class="text-decoration-none">
                    üîó Abrir chat completo
                </a>
            </small>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" integrity="sha384-0QUMZNJiVtKslS/L9DHQHiAZ5c2Ko2B9/D/L3g3f+1i2j1g/25L9c1hJ2gJ/b6W5" crossorigin="anonymous">

<script>
class ChatbotWidget {
    constructor() {
        this.isOpen = false;
        this.isTyping = false;
        this.unreadCount = 0;

        // Elementos do DOM
        this.dom = {
            widget: document.getElementById('chatbot-widget'),
            toggleBtn: document.getElementById('chatbot-toggle'),
            window: document.getElementById('chatbot-window'),
            closeBtn: document.getElementById('chatbot-close'),
            minimizeBtn: document.getElementById('chatbot-minimize'),
            sendBtn: document.getElementById('widget-send'),
            input: document.getElementById('widget-input'),
            messagesContainer: document.getElementById('widget-messages'),
            notificationBadge: document.getElementById('notification-badge'),
            welcomeMessage: document.querySelector('.welcome-message'),
            personalizationIndicator: document.getElementById('widget-personalization-indicator')
        };

        this.init();
    }

    init() {
        if (!this.dom.widget) return;
        this.bindEvents();
        this.setupAutoResize();

        // Exibir mensagem de boas-vindas se n√£o houver mensagens
        if (this.dom.messagesContainer && !this.dom.messagesContainer.querySelector('.message')) {
            this.showWelcomeMessage();
        } else if (this.dom.welcomeMessage) {
            this.dom.welcomeMessage.style.display = 'none';
        }

        console.log('ü§ñ Widget do Chatbot Liter√°rio inicializado.');
    }

    bindEvents() {
        this.dom.toggleBtn?.addEventListener('click', () => this.toggle());
        this.dom.closeBtn?.addEventListener('click', () => this.close());
        this.dom.minimizeBtn?.addEventListener('click', () => this.minimize());
        this.dom.sendBtn?.addEventListener('click', () => this.sendMessage());

        this.dom.input?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.currentTarget.dataset.action;
                if (action) this.sendAction(action);
            });
        });
    }

    setupAutoResize() {
        if (!this.dom.input) return;
        this.dom.input.addEventListener('input', function() {
            this.style.height = 'auto';
            const newHeight = Math.min(this.scrollHeight, 80);
            this.style.height = newHeight + 'px';
        });
    }

    showWelcomeMessage() {
        if (this.dom.welcomeMessage) {
            this.dom.welcomeMessage.style.display = 'flex';
        }
    }

    toggle() {
        this.isOpen ? this.close() : this.open();
    }

    open() {
        if (this.dom.window) {
            this.dom.window.style.display = 'flex';
            this.isOpen = true;

            if (this.dom.notificationBadge) {
                this.dom.notificationBadge.style.display = 'none';
                this.unreadCount = 0;
            }

            setTimeout(() => this.dom.input?.focus(), 300);
            this.scrollToBottom();
        }
    }

    close() {
        if (this.dom.window) {
            this.dom.window.style.display = 'none';
            this.isOpen = false;
        }
    }

    minimize() {
        this.close();
    }

    async sendMessage() {
        if (!this.dom.input) return;
        const message = this.dom.input.value.trim();

        if (!message || this.isTyping) return;

        this.dom.input.value = '';
        this.dom.input.style.height = 'auto';
        this.dom.input.focus();

        this.addMessage(message, 'user');

        this.showTypingIndicator();
        this.isTyping = true;

        try {
            const response = await this.callAPI('/chatbot/api/message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({ message: message })
            });

            this.hideTypingIndicator();

            if (response.response) {
                this.addMessage(response.response, 'bot', {
                    personalized: response.personalized,
                    timestamp: response.timestamp,
                    source: response.source
                });

                this.updatePersonalizationIndicator(response.personalized);

                if (!this.isOpen) {
                    this.unreadCount++;
                    this.showNotificationBadge(this.unreadCount);
                }
            } else {
                this.addMessage('Desculpe, ocorreu um erro. Tente novamente mais tarde.', 'bot', { error: true });
            }
        } catch (error) {
            console.error('‚ùå Erro no widget:', error);
            this.hideTypingIndicator();
            this.addMessage('Erro de conex√£o. Verifique sua internet e tente novamente.', 'bot', { error: true });
        } finally {
            this.isTyping = false;
        }
    }

    async sendAction(action) {
        if (this.isTyping) return;

        this.addMessage(`${this.getActionLabel(action)}`, 'user', { action: true });
        this.showTypingIndicator();
        this.isTyping = true;

        try {
            const response = await this.callAPI('/chatbot/api/message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({ action: action })
            });

            this.hideTypingIndicator();

            if (response.response) {
                this.addMessage(response.response, 'bot', {
                    action: action,
                    timestamp: response.timestamp
                });
            } else {
                this.addMessage('N√£o foi poss√≠vel executar esta a√ß√£o no momento.', 'bot', { error: true });
            }
        } catch (error) {
            console.error('‚ùå Erro na a√ß√£o:', error);
            this.hideTypingIndicator();
            this.addMessage('Erro ao executar a√ß√£o. Tente novamente.', 'bot', { error: true });
        } finally {
            this.isTyping = false;
        }
    }

    getActionLabel(action) {
        const labels = {
            'get_favorites': 'Meus Favoritos',
            'get_recommendations': 'Recomenda√ß√µes para mim',
            'get_reading_progress': 'Meu Progresso de Leitura'
        };
        return labels[action] || action;
    }

    addMessage(content, sender, metadata = {}) {
        if (!this.dom.messagesContainer) return;

        if (this.dom.welcomeMessage) {
            this.dom.welcomeMessage.style.display = 'none';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;

        const timestamp = metadata.timestamp || new Date().toLocaleTimeString('pt-BR', {
            hour: '2-digit', minute: '2-digit'
        });

        let personalizedIcon = '';
        if (sender === 'bot' && metadata.personalized) {
            personalizedIcon = ' <span title="Resposta personalizada" style="color: #ff6b6b; font-style: normal;">üé®</span>';
        }

        let sourceIcon = '';
        if (metadata.source && window.location.search.includes('debug=true')) {
            sourceIcon = ` <small style="opacity: 0.7;">[${metadata.source}]</small>`;
        }

        const messageClasses = `message-content ${metadata.error ? 'error' : ''} ${metadata.action ? 'action' : ''}`;

        messageDiv.innerHTML = `
            <div class="${messageClasses}">
                <div class="message-text">${this.formatMessage(content)}</div>
                <div class="message-meta">
                    <span class="timestamp">${timestamp}</span>${personalizedIcon}${sourceIcon}
                </div>
            </div>`;

        this.dom.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }

    formatMessage(content) {
        // Escapa HTML para evitar XSS
        const escapedContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");

        return escapedContent
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>')
            .replace(/üìö|üìñ|‚≠ê|üí°|üìä|üéØ|‚úÖ|‚ùå|üé®|üîç|ü§ñ/g, '<span style="font-size: 1.1em;">$&</span>');
    }

    showTypingIndicator() {
        if (!this.dom.messagesContainer) return;

        const indicator = document.createElement('div');
        indicator.id = 'widget-typing-indicator';
        indicator.className = 'widget-typing';
        indicator.innerHTML = `
            <div class="widget-typing-dots">
                <span></span><span></span><span></span>
            </div>`;

        this.dom.messagesContainer.appendChild(indicator);
        this.scrollToBottom();
    }



    hideTypingIndicator() {
        const indicator = document.getElementById('widget-typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    scrollToBottom() {
        if (this.dom.messagesContainer) {
            this.dom.messagesContainer.scrollTop = this.dom.messagesContainer.scrollHeight;
        }
    }

    updatePersonalizationIndicator(isPersonalized) {
        if (this.dom.personalizationIndicator) {
            this.dom.personalizationIndicator.style.opacity = isPersonalized ? '1' : '0.5';
            this.dom.personalizationIndicator.title = isPersonalized ? 'Personaliza√ß√£o Ativa' : 'Personaliza√ß√£o Inativa';
        }
    }

    showNotificationBadge(count = 1) {
        if (this.dom.notificationBadge) {
            this.dom.notificationBadge.textContent = count > 9 ? '9+' : count;
            this.dom.notificationBadge.style.display = 'flex';
        }
    }

    async callAPI(endpoint, options) {
        const response = await fetch(endpoint, options);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: response.statusText }));
            throw new Error(`HTTP ${response.status}: ${errorData.detail || 'Erro desconhecido'}`);
        }
        return await response.json();
    }

    getCSRFToken() {
        const name = 'csrftoken';
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    return decodeURIComponent(cookie.substring(name.length + 1));
                }
            }
        }
        return null;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('chatbot-widget')) {
        window.chatbotWidget = new ChatbotWidget();
    }
});
</script>