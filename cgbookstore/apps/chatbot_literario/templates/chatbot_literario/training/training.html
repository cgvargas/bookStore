{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}

{% block title %}Sistema de Treinamento do Chatbot Liter√°rio{% endblock %}

{% block branding %}
<h1 id="site-name">
    <a href="{% url 'admin:index' %}">Administra√ß√£o CG BookStore</a>
</h1>
{% endblock %}

{% block nav-global %}{% endblock %}

{% block extrastyle %}
    {{ block.super }} {# Mant√©m os estilos do pai, se houver #}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/training_styles.css' %}">
{% endblock %}

{% block content %}
<div class="training-main-container">
    <!-- Sidebar Navigation -->
    <div class="training-sidebar">
        {% include "admin/nav_sidebar.html" %}
    </div>

    <!-- Main Content Area -->
    <div class="training-content">
        <div class="chatbot-training-container">
            <h1 class="training-title">{{ title }}</h1>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="trainingTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                        üìä Dashboard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="simulator-tab" data-bs-toggle="tab" data-bs-target="#simulator" type="button" role="tab" aria-controls="simulator" aria-selected="false">
                        ü§ñ Simulador
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="knowledge-tab" data-bs-toggle="tab" data-bs-target="#knowledge" type="button" role="tab" aria-controls="knowledge" aria-selected="false">
                        üß† Base de Conhecimento
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="conversations-tab" data-bs-toggle="tab" data-bs-target="#conversations" type="button" role="tab" aria-controls="conversations" aria-selected="false">
                        üí¨ Conversas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="import-export-tab" data-bs-toggle="tab" data-bs-target="#import-export" type="button" role="tab" aria-controls="import-export" aria-selected="false">
                        üìÅ Importar/Exportar
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools" type="button" role="tab" aria-controls="tools" aria-selected="false">
                        üõ†Ô∏è Ferramentas
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="trainingTabContent">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                    <div class="stats-card">
                        <div class="stats-header">
                            <h3>üìä Estat√≠sticas Gerais</h3>
                        </div>
                        <div class="stats-body">
                            <div class="stats-row">
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.total_knowledge }}</div>
                                    <div class="stat-label">Total de Itens de Conhecimento</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.active_knowledge }}</div>
                                    <div class="stat-label">Itens Ativos</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.total_conversations }}</div>
                                    <div class="stat-label">Total de Mensagens</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.total_feedback }}</div>
                                    <div class="stat-label">Total de Feedbacks</div>
                                </div>
                            </div>
                            <div class="stats-row">
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.recent_knowledge }}</div>
                                    <div class="stat-label">Itens Recentes (30 dias)</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.satisfaction_rate|floatformat:1 }}%</div>
                                    <div class="stat-label">Taxa de Satisfa√ß√£o</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.with_embeddings }}</div>
                                    <div class="stat-label">Com Embeddings</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.without_embeddings }}</div>
                                    <div class="stat-label">Sem Embeddings</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Distribui√ß√£o por categoria -->
                    <div class="stats-card">
                        <div class="stats-header">
                            <h3>üìã Distribui√ß√£o por Categoria</h3>
                        </div>
                        <div class="stats-body">
                            <div class="category-distribution">
                                {% for category in stats.categories %}
                                <div class="category-item">
                                    <div class="category-name">{{ category.category|default:"(Sem categoria)" }}</div>
                                    <div class="category-bar">
                                        <div class="category-bar-fill" style="width: {% if stats.total_knowledge > 0 %}{% widthratio category.count stats.total_knowledge 100 %}{% else %}0{% endif %}%"></div>
                                    </div>
                                    <div class="category-count">{{ category.count }}</div>
                                </div>
                                {% empty %}
                                <p class="no-data">Nenhuma categoria encontrada.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Status dos embeddings -->
                    <div class="stats-card">
                        <div class="stats-header">
                            <h3>üß† Status dos Embeddings</h3>
                        </div>
                        <div class="stats-body">
                            <p class="status-info">
                                {% if stats.embeddings_available %}
                                <span class="badge badge-success">‚úÖ Dispon√≠vel</span>
                                Modelo de embeddings dispon√≠vel para busca sem√¢ntica.
                                {% else %}
                                <span class="badge badge-warning">‚ö†Ô∏è Indispon√≠vel</span>
                                Modelo de embeddings n√£o dispon√≠vel. Instale o pacote sentence-transformers para habilitar.
                                {% endif %}
                            </p>

                            {% if stats.with_embeddings > 0 or stats.without_embeddings > 0 %}
                            <div class="progress-section">
                                <p class="progress-title">Progresso de Gera√ß√£o de Embeddings</p>
                                <div class="progress-wrapper">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: {% if stats.total_knowledge > 0 %}{% widthratio stats.with_embeddings stats.total_knowledge 100 %}{% else %}0{% endif %}%">
                                            <span class="progress-text">{% if stats.total_knowledge > 0 %}{% widthratio stats.with_embeddings stats.total_knowledge 100 %}%{% else %}0%{% endif %}</span>
                                        </div>
                                    </div>
                                </div>
                                <small class="progress-details">{{ stats.with_embeddings }} de {{ stats.total_knowledge }} itens com embeddings</small>
                            </div>

                            <div class="action-section">
                                <form action="{% url 'update_embeddings' %}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="batch_size" value="100">
                                    <button type="submit" class="btn btn-primary" {% if not stats.embeddings_available %}disabled{% endif %}>
                                        üîÑ Atualizar Embeddings
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Simulador Tab -->
                <div class="tab-pane fade" id="simulator" role="tabpanel" aria-labelledby="simulator-tab">
                    <div class="chat-simulator">
                        <div class="chat-header">
                            <h3>ü§ñ Simulador do Chatbot</h3>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <div class="bot-message">
                                üëã Ol√°! Sou o assistente virtual da CG.BookStore.Online. Como posso ajudar?
                            </div>
                        </div>
                        <div class="chat-input">
                            <div class="input-group">
                                <input type="text" id="chatInput" class="form-control" placeholder="Digite sua mensagem...">
                                <button class="btn btn-primary" id="sendMessage">üì§ Enviar</button>
                            </div>
                        </div>
                    </div>

                    <div class="interaction-card">
                        <div class="card-header">
                            <h3>üí≠ √öltima Intera√ß√£o</h3>
                        </div>
                        <div class="card-body" id="lastInteraction">
                            <p class="no-interaction">Nenhuma intera√ß√£o recente.</p>
                        </div>
                        <div class="card-footer">
                            <form action="{% url 'add_from_conversation' %}" method="post" id="addInteractionForm">
                                {% csrf_token %}
                                <input type="hidden" name="user_input" id="userInputHidden">
                                <input type="hidden" name="bot_response" id="botResponseHidden">
                                <button type="submit" class="btn btn-success" disabled id="addInteractionBtn">
                                    ‚úÖ Adicionar √† Base de Conhecimento
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Base de Conhecimento Tab -->
                <div class="tab-pane fade" id="knowledge" role="tabpanel" aria-labelledby="knowledge-tab">
                    <div class="knowledge-form">
                        <h3>üß† Adicionar Item de Conhecimento</h3>
                        <form action="{% url 'add_knowledge_item' %}" method="post">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="question" class="form-label">‚ùì Pergunta</label>
                                <textarea class="form-control" id="question" name="question" rows="2" required placeholder="Digite a pergunta aqui..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="answer" class="form-label">üí° Resposta</label>
                                <textarea class="form-control" id="answer" name="answer" rows="3" required placeholder="Digite a resposta aqui..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="category" class="form-label">üè∑Ô∏è Categoria</label>
                                    <input type="text" class="form-control" id="category" name="category" placeholder="Ex: livros, autores, navega√ß√£o">
                                </div>
                                <div class="form-group">
                                    <label for="source" class="form-label">üìã Fonte</label>
                                    <input type="text" class="form-control" id="source" name="source" value="manual">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">‚úÖ Adicionar</button>
                        </form>
                    </div>

                    <div class="info-card">
                        <p>
                            üí° Para visualizar e gerenciar todos os itens de conhecimento, use a
                            <a href="/admin/chatbot_literario/knowledgeitem/" class="admin-link">interface de administra√ß√£o</a>.
                        </p>
                    </div>
                </div>

                <!-- Conversas Tab -->
                <div class="tab-pane fade" id="conversations" role="tabpanel" aria-labelledby="conversations-tab">
                    <h3>üí¨ Conversas Recentes</h3>
                    <div class="conversation-list">
                        {% for conversation in recent_conversations %}
                        <div class="conversation-item">
                            <div class="conversation-header">
                                <span class="conversation-user">üë§ {{ conversation.user.username }}</span>
                                <span class="conversation-date">üìÖ {{ conversation.started_at|date:"d/m/Y H:i" }}</span>
                                <form action="{% url 'add_from_conversation' %}" method="post" class="inline-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="user_input" value="{{ conversation.user_input }}">
                                    <input type="hidden" name="bot_response" value="{{ conversation.bot_response }}">
                                    <button type="submit" class="btn btn-success btn-sm">‚úÖ Adicionar √† Base</button>
                                </form>
                            </div>
                            <div class="conversation-content">
                                <p><strong>üë§ Usu√°rio:</strong> {{ conversation.user_input }}</p>
                                <p><strong>ü§ñ Chatbot:</strong> {{ conversation.bot_response }}</p>
                                {% if conversation.feedback %}
                                <div class="feedback-section">
                                    <span class="badge {% if conversation.feedback.helpful %}badge-success{% else %}badge-danger{% endif %}">
                                        {% if conversation.feedback.helpful %}üëç √ötil{% else %}üëé N√£o √∫til{% endif %}
                                    </span>
                                    {% if conversation.feedback.comment %}
                                    <p class="feedback-comment">üí¨ {{ conversation.feedback.comment }}</p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p class="no-data">üòî Nenhuma conversa recente encontrada.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Importar/Exportar Tab -->
                <div class="tab-pane fade" id="import-export" role="tabpanel" aria-labelledby="import-export-tab">
                    <div class="import-export-grid">
                        <div class="import-section">
                            <h3>üì• Importar Base de Conhecimento</h3>
                            <form action="{% url 'import_knowledge' %}" method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="importFile" class="form-label">üìÅ Arquivo</label>
                                    <input class="form-control" type="file" id="importFile" name="import_file" accept=".json,.csv" required>
                                </div>
                                <div class="form-group">
                                    <label for="formatSelect" class="form-label">üìã Formato</label>
                                    <select class="form-control" id="formatSelect" name="format">
                                        <option value="json">JSON</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">üì• Importar</button>
                            </form>
                        </div>

                        <div class="export-section">
                            <h3>üì§ Exportar Base de Conhecimento</h3>
                            <form action="{% url 'export_knowledge' %}" method="post">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="exportFormatSelect" class="form-label">üìã Formato</label>
                                    <select class="form-control" id="exportFormatSelect" name="format">
                                        <option value="json">JSON</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">üì§ Exportar</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Ferramentas Tab -->
                <div class="tab-pane fade" id="tools" role="tabpanel" aria-labelledby="tools-tab">
                    <div class="tools-grid">
                        <div class="tools-section">
                            <h3>üõ†Ô∏è Comandos do Sistema</h3>

                            <div class="tool-card">
                                <h4>üóìÔ∏è Adicionar Datas de Publica√ß√£o</h4>
                                <p>Adiciona datas espec√≠ficas de publica√ß√£o para livros principais (Hobbit, Senhor dos An√©is, etc.)</p>
                                <form action="{% url 'add_specific_dates' %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">‚ñ∂Ô∏è Executar Comando</button>
                                </form>
                            </div>

                            <div class="tool-card">
                                <h4>üîç Debug do Chatbot</h4>
                                <p>Executa diagn√≥stico completo do chatbot com diferentes tipos de an√°lise</p>
                                <form action="{% url 'debug_chatbot' %}" method="post">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <label class="form-label">üéØ Tipo de Debug:</label>
                                        <select class="form-control" name="debug_action">
                                            <option value="knowledge">üìö Knowledge - Analisar base de conhecimento</option>
                                            <option value="test">üß™ Test - Testar query espec√≠fica</option>
                                            <option value="integration">üîó Integration - Testar integra√ß√£o Ollama</option>
                                            <option value="benchmark">‚ö° Benchmark - Teste de performance</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">üîç Executar Debug</button>
                                </form>
                            </div>

                            <div class="tool-card danger">
                                <h4>üßπ Limpeza da Base de Conhecimento</h4>
                                <p>‚ö†Ô∏è Identifica e marca como inativos dados contaminados ou incorretos</p>
                                <form action="{% url 'clean_knowledge' %}" method="post" onsubmit="return confirm('Tem certeza? Esta a√ß√£o ir√° marcar dados problem√°ticos como inativos.')">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger">üßπ Executar Limpeza</button>
                                </form>
                            </div>
                        </div>

                        <div class="tools-section">
                            <h3>üìä Relat√≥rios e Configura√ß√µes</h3>

                            <div class="tool-card">
                                <h4>üìä Estat√≠sticas Avan√ßadas</h4>
                                <p>Visualiza estat√≠sticas detalhadas com gr√°ficos e m√©tricas avan√ßadas</p>
                                <a href="{% url 'advanced_statistics' %}" class="btn btn-primary">üìà Ver Estat√≠sticas</a>
                            </div>

                            <div class="tool-card">
                                <h4>‚öôÔ∏è Configura√ß√µes do Sistema</h4>
                                <p>Ajusta par√¢metros do chatbot como thresholds e configura√ß√µes de busca</p>
                                <a href="{% url 'system_config' %}" class="btn btn-primary">‚öôÔ∏è Configura√ß√µes</a>
                            </div>

                            <div class="status-card">
                                <h4>üìà Status do Sistema</h4>
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-icon {% if stats.embeddings_available %}success{% else %}warning{% endif %}">
                                            {% if stats.embeddings_available %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}
                                        </div>
                                        <div class="status-label">Embeddings</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-number {% if stats.total_knowledge > 0 %}success{% else %}danger{% endif %}">
                                            {{ stats.total_knowledge }}
                                        </div>
                                        <div class="status-label">Itens Ativos</div>
                                    </div>
                                </div>
                                <div class="status-timestamp">‚è∞ √öltima atualiza√ß√£o: agora</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}