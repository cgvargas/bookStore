{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}

{% block title %}Sistema de Treinamento do Chatbot LiterÃ¡rio{% endblock %}

{% block branding %}
<h1 id="site-name">
    <a href="{% url 'admin:index' %}">AdministraÃ§Ã£o CG BookStore</a>
</h1>
{% endblock %}

{% block nav-global %}{% endblock %}

{% block extrastyle %}
    {{ block.super }} {# MantÃ©m os estilos do pai, se houver #}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/training_styles.css' %}">
{% endblock %}

{% block content %}
<div class="training-main-container">
    <!-- Sidebar Navigation -->
    <div class="training-sidebar">
        {% include "admin/nav_sidebar.html" %}
    </div>

    <!-- Main Content Area -->
    <div class="training-content">
        <div class="chatbot-training-container">
            <h1 class="training-title">{{ title }}</h1>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="trainingTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                        ğŸ“Š Dashboard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="simulator-tab" data-bs-toggle="tab" data-bs-target="#simulator" type="button" role="tab" aria-controls="simulator" aria-selected="false">
                        ğŸ¤– Simulador
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="knowledge-tab" data-bs-toggle="tab" data-bs-target="#knowledge" type="button" role="tab" aria-controls="knowledge" aria-selected="false">
                        ğŸ§  Base de Conhecimento
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="conversations-tab" data-bs-toggle="tab" data-bs-target="#conversations" type="button" role="tab" aria-controls="conversations" aria-selected="false">
                        ğŸ’¬ Conversas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="import-export-tab" data-bs-toggle="tab" data-bs-target="#import-export" type="button" role="tab" aria-controls="import-export" aria-selected="false">
                        ğŸ“ Importar/Exportar
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools" type="button" role="tab" aria-controls="tools" aria-selected="false">
                        ğŸ› ï¸ Ferramentas
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="trainingTabContent">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                    <div class="stats-card">
                        <div class="stats-header">
                            <h3>ğŸ“Š EstatÃ­sticas Gerais</h3>
                        </div>
                        <div class="stats-body">
                            <div class="stats-row">
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.total_knowledge }}</div>
                                    <div class="stat-label">Total de Itens de Conhecimento</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.active_knowledge }}</div>
                                    <div class="stat-label">Itens Ativos</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.total_conversations }}</div>
                                    <div class="stat-label">Total de Mensagens</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.total_feedback }}</div>
                                    <div class="stat-label">Total de Feedbacks</div>
                                </div>
                            </div>
                            <div class="stats-row">
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.recent_knowledge }}</div>
                                    <div class="stat-label">Itens Recentes (30 dias)</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.satisfaction_rate|floatformat:1 }}%</div>
                                    <div class="stat-label">Taxa de SatisfaÃ§Ã£o</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.with_embeddings }}</div>
                                    <div class="stat-label">Com Embeddings</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ stats.without_embeddings }}</div>
                                    <div class="stat-label">Sem Embeddings</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DistribuiÃ§Ã£o por categoria -->
                    <div class="stats-card">
                        <div class="stats-header">
                            <h3>ğŸ“‹ DistribuiÃ§Ã£o por Categoria</h3>
                        </div>
                        <div class="stats-body">
                            <div class="category-distribution">
                                {% for category in stats.categories %}
                                <div class="category-item">
                                    <div class="category-name">{{ category.category|default:"(Sem categoria)" }}</div>
                                    <div class="category-bar">
                                        <div class="category-bar-fill" style="width: {% if stats.total_knowledge > 0 %}{% widthratio category.count stats.total_knowledge 100 %}{% else %}0{% endif %}%"></div>
                                    </div>
                                    <div class="category-count">{{ category.count }}</div>
                                </div>
                                {% empty %}
                                <p class="no-data">Nenhuma categoria encontrada.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Status dos embeddings -->
                    <div class="stats-card">
                        <div class="stats-header">
                            <h3>ğŸ§  Status dos Embeddings</h3>
                        </div>
                        <div class="stats-body">
                            <p class="status-info">
                                {% if stats.embeddings_available %}
                                <span class="badge badge-success">âœ… DisponÃ­vel</span>
                                Modelo de embeddings disponÃ­vel para busca semÃ¢ntica.
                                {% else %}
                                <span class="badge badge-warning">âš ï¸ IndisponÃ­vel</span>
                                Modelo de embeddings nÃ£o disponÃ­vel. Instale o pacote sentence-transformers para habilitar.
                                {% endif %}
                            </p>

                            {% if stats.with_embeddings > 0 or stats.without_embeddings > 0 %}
                            <div class="progress-section">
                                <p class="progress-title">Progresso de GeraÃ§Ã£o de Embeddings</p>
                                <div class="progress-wrapper">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: {% if stats.total_knowledge > 0 %}{% widthratio stats.with_embeddings stats.total_knowledge 100 %}{% else %}0{% endif %}%">
                                            <span class="progress-text">{% if stats.total_knowledge > 0 %}{% widthratio stats.with_embeddings stats.total_knowledge 100 %}%{% else %}0%{% endif %}</span>
                                        </div>
                                    </div>
                                </div>
                                <small class="progress-details">{{ stats.with_embeddings }} de {{ stats.total_knowledge }} itens com embeddings</small>
                            </div>

                            <div class="action-section">
                                <form action="{% url 'update_embeddings' %}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="batch_size" value="100">
                                    <button type="submit" class="btn btn-primary" {% if not stats.embeddings_available %}disabled{% endif %}>
                                        ğŸ”„ Atualizar Embeddings
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Simulador Tab -->
                <div class="tab-pane fade" id="simulator" role="tabpanel" aria-labelledby="simulator-tab">
                    <div class="chat-simulator">
                        <div class="chat-header">
                            <h3>ğŸ¤– Simulador do Chatbot</h3>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <div class="bot-message">
                                ğŸ‘‹ OlÃ¡! Sou o assistente virtual da CG.BookStore.Online. Como posso ajudar?
                            </div>
                        </div>
                        <div class="chat-input">
                            <div class="input-group">
                                <input type="text" id="chatInput" class="form-control" placeholder="Digite sua mensagem...">
                                <button class="btn btn-primary" id="sendMessage">ğŸ“¤ Enviar</button>
                            </div>
                        </div>
                    </div>

                    <div class="interaction-card">
                        <div class="card-header">
                            <h3>ğŸ’­ Ãšltima InteraÃ§Ã£o</h3>
                        </div>
                        <div class="card-body" id="lastInteraction">
                            <p class="no-interaction">Nenhuma interaÃ§Ã£o recente.</p>
                        </div>
                        <div class="card-footer">
                            <form action="{% url 'add_from_conversation' %}" method="post" id="addInteractionForm">
                                {% csrf_token %}
                                <input type="hidden" name="user_input" id="userInputHidden">
                                <input type="hidden" name="bot_response" id="botResponseHidden">
                                <button type="submit" class="btn btn-success" disabled id="addInteractionBtn">
                                    âœ… Adicionar Ã  Base de Conhecimento
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Base de Conhecimento Tab -->
                <div class="tab-pane fade" id="knowledge" role="tabpanel" aria-labelledby="knowledge-tab">
                    <div class="knowledge-form">
                        <h3>ğŸ§  Adicionar Item de Conhecimento</h3>
                        <form action="{% url 'add_knowledge_item' %}" method="post">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="question" class="form-label">â“ Pergunta</label>
                                <textarea class="form-control" id="question" name="question" rows="2" required placeholder="Digite a pergunta aqui..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="answer" class="form-label">ğŸ’¡ Resposta</label>
                                <textarea class="form-control" id="answer" name="answer" rows="3" required placeholder="Digite a resposta aqui..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="category" class="form-label">ğŸ·ï¸ Categoria</label>
                                    <input type="text" class="form-control" id="category" name="category" placeholder="Ex: livros, autores, navegaÃ§Ã£o">
                                </div>
                                <div class="form-group">
                                    <label for="source" class="form-label">ğŸ“‹ Fonte</label>
                                    <input type="text" class="form-control" id="source" name="source" value="manual">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">âœ… Adicionar</button>
                        </form>
                    </div>

                    <div class="info-card">
                        <p>
                            ğŸ’¡ Para visualizar e gerenciar todos os itens de conhecimento, use a
                            <a href="/admin/chatbot_literario/knowledgeitem/" class="admin-link">interface de administraÃ§Ã£o</a>.
                        </p>
                    </div>
                </div>

                <!-- Conversas Tab -->
                <div class="tab-pane fade" id="conversations" role="tabpanel" aria-labelledby="conversations-tab">
                    <h3>ğŸ’¬ Conversas Recentes</h3>
                    <div class="conversation-list">
                        {% for conversation in recent_conversations %}
                        <div class="conversation-item">
                            <div class="conversation-header">
                                <span class="conversation-user">ğŸ‘¤ {{ conversation.user.username }}</span>
                                <span class="conversation-date">ğŸ“… {{ conversation.started_at|date:"d/m/Y H:i" }}</span>
                                <form action="{% url 'add_from_conversation' %}" method="post" class="inline-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="user_input" value="{{ conversation.user_input }}">
                                    <input type="hidden" name="bot_response" value="{{ conversation.bot_response }}">
                                    <button type="submit" class="btn btn-success btn-sm">âœ… Adicionar Ã  Base</button>
                                </form>
                            </div>
                            <div class="conversation-content">
                                <p><strong>ğŸ‘¤ UsuÃ¡rio:</strong> {{ conversation.user_input }}</p>
                                <p><strong>ğŸ¤– Chatbot:</strong> {{ conversation.bot_response }}</p>
                                {% if conversation.feedback %}
                                <div class="feedback-section">
                                    <span class="badge {% if conversation.feedback.helpful %}badge-success{% else %}badge-danger{% endif %}">
                                        {% if conversation.feedback.helpful %}ğŸ‘ Ãštil{% else %}ğŸ‘ NÃ£o Ãºtil{% endif %}
                                    </span>
                                    {% if conversation.feedback.comment %}
                                    <p class="feedback-comment">ğŸ’¬ {{ conversation.feedback.comment }}</p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p class="no-data">ğŸ˜” Nenhuma conversa recente encontrada.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Importar/Exportar Tab -->
                <div class="tab-pane fade" id="import-export" role="tabpanel" aria-labelledby="import-export-tab">
                    <div class="import-export-grid">
                        <div class="import-section">
                            <h3>ğŸ“¥ Importar Base de Conhecimento</h3>
                            <form action="{% url 'import_knowledge' %}" method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="importFile" class="form-label">ğŸ“ Arquivo</label>
                                    <input class="form-control" type="file" id="importFile" name="import_file" accept=".json,.csv" required>
                                </div>
                                <div class="form-group">
                                    <label for="formatSelect" class="form-label">ğŸ“‹ Formato</label>
                                    <select class="form-control" id="formatSelect" name="format">
                                        <option value="json">JSON</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">ğŸ“¥ Importar</button>
                            </form>
                        </div>

                        <div class="export-section">
                            <h3>ğŸ“¤ Exportar Base de Conhecimento</h3>
                            <form action="{% url 'export_knowledge' %}" method="post">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="exportFormatSelect" class="form-label">ğŸ“‹ Formato</label>
                                    <select class="form-control" id="exportFormatSelect" name="format">
                                        <option value="json">JSON</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">ğŸ“¤ Exportar</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Ferramentas Tab -->
                <div class="tab-pane fade" id="tools" role="tabpanel" aria-labelledby="tools-tab">
                    <div class="tools-grid">
                        <div class="tools-section">
                            <h3>ğŸ› ï¸ Comandos do Sistema</h3>

                            <div class="tool-card">
                                <h4>ğŸ—“ï¸ Adicionar Datas de PublicaÃ§Ã£o</h4>
                                <p>Adiciona datas especÃ­ficas de publicaÃ§Ã£o para livros principais (Hobbit, Senhor dos AnÃ©is, etc.)</p>
                                <form action="{% url 'add_specific_dates' %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">â–¶ï¸ Executar Comando</button>
                                </form>
                            </div>

                            <div class="tool-card">
                                <h4>ğŸ” Debug do Chatbot</h4>
                                <p>Executa diagnÃ³stico completo do chatbot com diferentes tipos de anÃ¡lise</p>
                                <form action="{% url 'debug_chatbot' %}" method="post">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <label class="form-label">ğŸ¯ Tipo de Debug:</label>
                                        <select class="form-control" name="debug_action">
                                            <option value="knowledge">ğŸ“š Knowledge - Analisar base de conhecimento</option>
                                            <option value="test">ğŸ§ª Test - Testar query especÃ­fica</option>
                                            <option value="integration">ğŸ”— Integration - Testar integraÃ§Ã£o Ollama</option>
                                            <option value="benchmark">âš¡ Benchmark - Teste de performance</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">ğŸ” Executar Debug</button>
                                </form>
                            </div>

                            <div class="tool-card danger">
                                <h4>ğŸ§¹ Limpeza da Base de Conhecimento</h4>
                                <p>âš ï¸ Identifica e marca como inativos dados contaminados ou incorretos</p>
                                <form action="{% url 'clean_knowledge' %}" method="post" onsubmit="return confirm('Tem certeza? Esta aÃ§Ã£o irÃ¡ marcar dados problemÃ¡ticos como inativos.')">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger">ğŸ§¹ Executar Limpeza</button>
                                </form>
                            </div>
                        </div>

                        <div class="tools-section">
                            <h3>ğŸ“Š RelatÃ³rios e ConfiguraÃ§Ãµes</h3>

                            <div class="tool-card">
                                <h4>ğŸ“Š EstatÃ­sticas AvanÃ§adas</h4>
                                <p>Visualiza estatÃ­sticas detalhadas com grÃ¡ficos e mÃ©tricas avanÃ§adas</p>
                                <a href="{% url 'advanced_statistics' %}" class="btn btn-primary">ğŸ“ˆ Ver EstatÃ­sticas</a>
                            </div>

                            <div class="tool-card">
                                <h4>âš™ï¸ ConfiguraÃ§Ãµes do Sistema</h4>
                                <p>Ajusta parÃ¢metros do chatbot como thresholds e configuraÃ§Ãµes de busca</p>
                                <a href="{% url 'system_config' %}" class="btn btn-primary">âš™ï¸ ConfiguraÃ§Ãµes</a>
                            </div>

                            <div class="status-card">
                                <h4>ğŸ“ˆ Status do Sistema</h4>
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-icon {% if stats.embeddings_available %}success{% else %}warning{% endif %}">
                                            {% if stats.embeddings_available %}âœ…{% else %}âš ï¸{% endif %}
                                        </div>
                                        <div class="status-label">Embeddings</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-number {% if stats.total_knowledge > 0 %}success{% else %}danger{% endif %}">
                                            {{ stats.total_knowledge }}
                                        </div>
                                        <div class="status-label">Itens Ativos</div>
                                    </div>
                                </div>
                                <div class="status-timestamp">â° Ãšltima atualizaÃ§Ã£o: agora</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}