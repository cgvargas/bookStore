{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
{{ block.super }}
<style>
    .training-container {
        padding: 20px;
        background-color: #f9f9fa;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .training-header {
        margin-bottom: 20px;
    }
    
    .training-section {
        margin-bottom: 30px;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .training-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        flex: 1;
        min-width: 200px;
        padding: 15px;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2271b1;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #50575e;
    }
    
    .chat-simulator {
        display: flex;
        flex-direction: column;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .chat-messages {
        height: 300px;
        overflow-y: auto;
        padding: 15px;
        background-color: #f1f1f1;
    }
    
    .message {
        padding: 10px 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        max-width: 80%;
    }
    
    .user-message {
        background-color: #e3effd;
        margin-left: auto;
    }
    
    .bot-message {
        background-color: white;
        margin-right: auto;
    }
    
    .chat-input {
        display: flex;
        padding: 10px;
        background-color: white;
        border-top: 1px solid #ddd;
    }
    
    .chat-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-right: 10px;
    }
    
    .knowledge-form {
        margin-top: 20px;
    }
    
    .tab-container {
        margin-top: 20px;
    }
    
    .tab-nav {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
    }
    
    .tab-link {
        padding: 10px 15px;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        margin-bottom: -1px;
    }
    
    .tab-link.active {
        background-color: white;
        border-color: #ddd;
        border-bottom-color: white;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .recent-conversations {
        margin-top: 20px;
    }
    
    .conversation-item {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
    }
    
    .conversation-user {
        font-weight: bold;
    }
    
    .conversation-time {
        color: #666;
        font-size: 0.8em;
    }
    
    .import-export-section {
        display: flex;
        gap: 20px;
    }
    
    .import-form, .export-form {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="training-container">
    <div class="training-header">
        <h1>Treinamento do Chatbot Literário</h1>
        <p>Use esta interface para gerenciar e treinar o chatbot literário.</p>
    </div>
    
    <div class="training-section">
        <h2>Estatísticas</h2>
        <div class="training-stats">
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_conversations }}</div>
                <div class="stat-label">Conversas Registradas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_knowledge_items }}</div>
                <div class="stat-label">Itens na Base de Conhecimento</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.positive_feedback }}</div>
                <div class="stat-label">Feedback Positivo</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.negative_feedback }}</div>
                <div class="stat-label">Feedback Negativo</div>
            </div>
        </div>
    </div>
    
    <div class="training-section">
        <h2>Simulador de Chat</h2>
        <p>Teste o chatbot e veja como ele responde às suas perguntas.</p>
        
        <div class="chat-simulator">
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    Olá! Sou o assistente literário da CG.BookStore. Como posso ajudar você hoje?
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="userMessage" placeholder="Digite sua pergunta para testar o chatbot...">
                <button class="button" id="sendBtn">Enviar</button>
            </div>
        </div>
    </div>
    
    <div class="training-section">
        <h2>Gerenciamento de Conhecimento</h2>
        
        <div class="tab-container">
            <div class="tab-nav">
                <div class="tab-link active" data-tab="add-knowledge">Adicionar Conhecimento</div>
                <div class="tab-link" data-tab="import-export">Importar / Exportar</div>
                <div class="tab-link" data-tab="recent-convs">Conversas Recentes</div>
            </div>
            
            <div class="tab-content active" id="add-knowledge">
                <h3>Adicionar Item à Base de Conhecimento</h3>
                <p>Adicione manualmente novos pares de pergunta-resposta à base de conhecimento.</p>
                
                <form class="knowledge-form" method="post" action="{% url 'admin:add_knowledge_item' %}">
                    {% csrf_token %}
                    <div class="form-row field-question">
                        <div class="field-box">
                            <label for="id_question">Pergunta:</label>
                            <input type="text" name="question" class="vTextField" id="id_question" required maxlength="255">
                        </div>
                    </div>
                    <div class="form-row field-answer">
                        <div class="field-box">
                            <label for="id_answer">Resposta:</label>
                            <textarea name="answer" rows="5" cols="40" class="vLargeTextField" id="id_answer" required></textarea>
                        </div>
                    </div>
                    <div class="form-row field-category">
                        <div class="field-box">
                            <label for="id_category">Categoria:</label>
                            <select name="category" id="id_category">
                                <option value="livros">Livros</option>
                                <option value="autores">Autores</option>
                                <option value="generos">Gêneros Literários</option>
                                <option value="navegacao">Navegação no Site</option>
                                <option value="recomendacoes">Recomendações</option>
                                <option value="faq">Perguntas Frequentes</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row field-source">
                        <div class="field-box">
                            <label for="id_source">Fonte:</label>
                            <input type="text" name="source" class="vTextField" id="id_source" value="manual">
                        </div>
                    </div>

                    <div class="submit-row">
                        <input type="submit" value="Adicionar Item" class="default" name="_save">
                    </div>
                </form>
            </div>

            <div class="tab-content" id="import-export">
                <div class="import-export-section">
                    <div class="import-form">
                        <h3>Importar Base de Conhecimento</h3>
                        <p>Importe dados de um arquivo CSV ou JSON.</p>

                        <form method="post" action="{% url 'admin:import_knowledge' %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="form-row">
                                <label for="id_import_file">Arquivo:</label>
                                <input type="file" name="import_file" id="id_import_file" required accept=".csv,.json">
                            </div>
                            <div class="form-row">
                                <label for="id_import_format">Formato:</label>
                                <select name="format" id="id_import_format">
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                            <div class="submit-row">
                                <input type="submit" value="Importar" class="default" name="_import">
                            </div>
                        </form>
                    </div>

                    <div class="export-form">
                        <h3>Exportar Base de Conhecimento</h3>
                        <p>Exporte dados para CSV ou JSON.</p>

                        <form method="post" action="{% url 'admin:export_knowledge' %}">
                            {% csrf_token %}
                            <div class="form-row">
                                <label for="id_export_format">Formato:</label>
                                <select name="format" id="id_export_format">
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                            <div class="submit-row">
                                <input type="submit" value="Exportar" class="default" name="_export">
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="recent-convs">
                <h3>Conversas Recentes</h3>
                <p>Veja as conversas recentes com o chatbot e adicione respostas úteis à base de conhecimento.</p>

                <div class="recent-conversations">
                    {% if recent_conversations %}
                        {% for conv in recent_conversations %}
                            <div class="conversation-item">
                                <div class="conversation-header">
                                    <span class="conversation-user">{{ conv.user.username }}</span>
                                    <span class="conversation-time">{{ conv.timestamp|date:"d/m/Y H:i" }}</span>
                                </div>
                                <div class="conversation-content">
                                    <div class="user-query">
                                        <strong>Usuário:</strong> {{ conv.user_input }}
                                    </div>
                                    <div class="bot-response">
                                        <strong>Chatbot:</strong> {{ conv.bot_response }}
                                    </div>
                                </div>
                                <div class="conversation-actions">
                                    <form method="post" action="{% url 'admin:add_to_knowledge' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="user_input" value="{{ conv.user_input }}">
                                        <input type="hidden" name="bot_response" value="{{ conv.bot_response }}">
                                        <button type="submit" class="button">Adicionar à Base de Conhecimento</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>Nenhuma conversa registrada ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tabs funcionality
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        tabLinks.forEach(link => {
            link.addEventListener('click', function() {
                const tabId = this.dataset.tab;

                // Remove active class from all tabs
                tabLinks.forEach(tab => tab.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Add active class to clicked tab
                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Chat simulator
        const chatMessages = document.getElementById('chatMessages');
        const userMessage = document.getElementById('userMessage');
        const sendBtn = document.getElementById('sendBtn');

        sendBtn.addEventListener('click', function() {
            const message = userMessage.value.trim();
            if (message) {
                addMessage(message, 'user');
                userMessage.value = '';

                // Send to the API
                fetch('{% url "admin:test_chatbot" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ message: message })
                })
                .then(response => response.json())
                .then(data => {
                    addMessage(data.response, 'bot');
                })
                .catch(error => {
                    console.error('Error:', error);
                    addMessage('Erro ao processar a mensagem. Por favor, tente novamente.', 'bot');
                });
            }
        });

        userMessage.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender + '-message');
            messageDiv.textContent = content;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
{% endblock %}